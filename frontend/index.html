<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EduFAD ‚Äì Strumento educativo per il funzionamento adattivo</title>
  <style>
    :root{
  --bg:#2f5fa5;            /* blu professionale */
  --card:#eef4fb;          /* quasi bianco */

  --text:#374151;          /* grigio scuro leggibile */
  --muted:#6b7280;         /* grigio medio */
  --line:#1e3a8a;

  --accent:#fb923c;        /* arancione chiaro */
  --accent2:#f97316;
  --primary:#1e3a8a;

  --danger:#dc2626;
  --warn:#f59e0b;

  --shadow:0 10px 26px rgba(2,6,23,.28);
  --radius:16px;
  --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); background:radial-gradient(1000px 600px at 20% 0%, #16224a 0%, var(--bg) 55%);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:sticky; top:10px; z-index:5; backdrop-filter: blur(10px);
    }
    header h1{margin:0; font-size:16px; letter-spacing:.2px}
    header .sub{color:var(--muted); font-size:12px}
    .top-left{display:flex; flex-direction:column; gap:2px}
    .top-right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      background:rgba(255,255,255,.03); color:var(--muted); font-size:12px
    }
    button, input, select, textarea{
      font-family:inherit; color:var(--text);
      background:rgba(255,255,255,.03); border:1px solid var(--line);
      border-radius:12px; padding:10px 12px; outline:none;
    }
    textarea{min-height:80px; resize:vertical}
    input::placeholder, textarea::placeholder{color:#7f8db0}
    button{cursor:pointer}
    button.primary{border-color:rgba(106,169,255,.55); background:rgba(106,169,255,.15)}
    button.danger{border-color:rgba(255,106,122,.55); background:rgba(255,106,122,.12)}
    button.ghost{background:transparent}
    button:disabled{opacity:.5; cursor:not-allowed}
    .grid{
      display:grid; gap:14px; margin-top:14px;
      grid-template-columns: 320px 1fr;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      header{position:static}
    }
    .card{
      border:1px solid var(--line); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .bd{padding:14px 16px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row > *{flex:1}
    .row.tight > *{flex:0}
    .sep{height:1px; background:var(--line); margin:12px 0}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family:var(--mono)}
    .list{display:flex; flex-direction:column; gap:8px}
    .item{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px; border:1px solid var(--line); border-radius:14px;
      background:rgba(255,255,255,.02);
    }
    .item .left{display:flex; flex-direction:column; gap:2px; min-width:0}
    .item .title{font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .item .meta{font-size:12px; color:var(--muted)}
    .item .right{display:flex; gap:8px; align-items:center; flex:0 0 auto}
    .badge{
      font-size:11px; color:#dbe6ff;
      padding:6px 8px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted); font-size:12px; background:rgba(255,255,255,.02);
      cursor:pointer; user-select:none;
    }
    .tab.active{color:var(--text); border-color:rgba(106,169,255,.55); background:rgba(106,169,255,.14)}
    .table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid var(--line); border-radius:14px}
    .table th,.table td{padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:top}
    .table th{font-size:12px; text-align:left; color:var(--muted); background:rgba(255,255,255,.02)}
    .table tr:last-child td{border-bottom:none}
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .controls .group{display:flex; gap:6px; align-items:center}
    .radio-group{display:flex; gap:6px; flex-wrap:wrap}
    .radio{
      display:inline-flex; align-items:center; justify-content:center;
      width:34px; height:34px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.02); cursor:pointer; user-select:none;
      font-weight:600; font-size:12px;
    }
    .radio.on{border-color:rgba(106,169,255,.75); background:rgba(106,169,255,.18)}
    .kpi{
      display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;
    }
    .kpi .box{
      padding:12px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.02);
    }
    .kpi .box .v{font-size:18px; font-weight:700}
    .kpi .box .l{font-size:12px; color:var(--muted)}
    canvas{width:100%; height:320px; min-height:320px; background:#ffffff; border:1px solid var(--line); border-radius:14px}
    .toast{
      position:fixed; right:18px; bottom:18px; max-width:360px;
      padding:12px 14px; border-radius:14px; border:1px solid var(--line);
      background:rgba(17,26,51,.92); box-shadow:var(--shadow);
      color:var(--text); font-size:12px; display:none;
    }
    .toast.show{display:block}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .two-col{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width: 980px){ .two-col{grid-template-columns:1fr} }
  

/* Forza bottoni cliccabili arancioni */
.btn,
button,
input[type="submit"],
input[type="button"]{
  background:var(--accent) !important;
  color:#fff !important;
  border-color:var(--accent) !important;
}

.btn:hover,
button:hover{
  background:var(--accent2) !important;
}


/* Tasti principali (Apri / Seleziona) in blu scuro */
.btn.primary,
.btn.open,
.btn.select,
button.primary,
button.open,
button.select{
  background:var(--primary) !important;
  color:#ffffff !important;
  border-color:var(--primary) !important;
}

.btn.primary:hover,
.btn.open:hover,
.btn.select:hover,
button.primary:hover,
button.open:hover,
button.select:hover{
  background:#1d4ed8 !important;
}

/* Altri bottoni arancione chiaro */
.btn,
button,
input[type="submit"],
input[type="button"]{
  background:var(--accent) !important;
  color:#7c2d12 !important;
  border-color:var(--accent2) !important;
}

.btn:hover,
button:hover{
  background:var(--accent2) !important;
  color:#ffffff !important;
}


/* Migliora visibilit√† bottoni nei cerchi (Apri / Seleziona) */
.circle-btn,
.toggle,
.switch,
.round-btn,
button[aria-label],
button.circle{
  background:#1e3a8a !important;   /* blu molto scuro */
  border:2px solid #0f172a !important;
  color:#ffffff !important;
}

/* Icone dentro i cerchi */
.circle-btn svg,
.toggle svg,
.round-btn svg,
button svg{
  fill:#ffffff !important;
  stroke:#ffffff !important;
}

/* Hover pi√π evidente */
.circle-btn:hover,
.toggle:hover,
.round-btn:hover,
button.circle:hover{
  background:#1d4ed8 !important;
  border-color:#1d4ed8 !important;
}


/* === FIX DEFINITIVO BOTTONI TONDI === */

/* Tutti i bottoni piccoli/rotondi */
button,
.btn,
.toggle,
.switch,
.circle,
.round,
[role="button"]{
  position: relative;
}

/* Bottoni tondi nelle liste */
.rrow button,
.rrow .btn,
li button,
.card button{
  background:#1e40af !important;   /* blu molto scuro */
  border:2px solid #0f172a !important;
  color:#ffffff !important;
  opacity:1 !important;
}

/* Stato selezionato */
.rrow button.active,
.rrow button.selected,
.card button.active{
  background:#ea580c !important;   /* arancione vivo */
  border-color:#9a3412 !important;
  color:#ffffff !important;
}

/* Icone dentro */
button svg,
button i,
button span{
  color:#ffffff !important;
  fill:#ffffff !important;
  stroke:#ffffff !important;
}

/* Hover */
.rrow button:hover,
.card button:hover{
  background:#2563eb !important;
  border-color:#2563eb !important;
}


/* Forza sfondo blu su tutta l'app */
body, .app, .wrap, .container, main{
  background:#2563eb !important;
}


/* Forza sfondo professionale */
body, .app, .wrap, .container, main{
  background:#2f5fa5 !important;
}


/* Migliora leggibilit√† testi */
body, p, li, span, div, label{
  color:var(--text) !important;
}

.small, .muted, .hint, .note{
  color:var(--muted) !important;
}

h1, h2, h3, h4{
  color:#1f2933 !important;
}


/* Testi bianchi su sfondo blu */
body,
header,
.topbar,
.sidebar,
.nav,
.navbar,
.app,
.wrap,
.container{
  color:#ffffff !important;
}

/* Link e pulsanti su blu */
header a,
.sidebar a,
.nav a{
  color:#ffffff !important;
}

/* Mantieni scuri i testi sulle card */
.card,
.panel,
.box,
.section,
main{
  color:var(--text) !important;
  background:var(--card) !important;
}


/* Login overlay */
#loginOverlay .btn{ background: var(--accent2) !important; color:#fff !important; border-color: var(--accent2) !important; }
#loginOverlay .btn:hover{ background: var(--accent) !important; }


/* Privacy login: blocca vista sotto */
#loginOverlay{
  backdrop-filter:none !important;
}

/* Badge nome utente */
#userBadge{
  display:none;
  margin-left:10px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(255,255,255,.10);
  color:#fff;
  font-size:12px;
  font-weight:800;
  align-self:center;
}
</style>


<style>
/* Privacy totale durante disclaimer: copre TUTTO con colore pieno */
#disclaimerOverlay{
  position:fixed !important;
  inset:0 !important;
  background:#0f172a !important; /* blu pieno, nessuna trasparenza */
  backdrop-filter:none !important;
  -webkit-backdrop-filter:none !important;
  z-index:10000 !important;
}
</style>

</head>
<body>

  <!-- LEGENDA POPUP -->
  <div id="legendModal" style="position:fixed; inset:0; background:rgba(2,6,23,.75); display:none; align-items:center; justify-content:center; padding:18px; z-index:9996;">
    <div style="max-width:720px; width:100%; background:var(--card);
                border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px 14px 10px;">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:900; font-size:16px; color:var(--text);">üìò Legenda valutazione</div>
          <div class="small muted" style="margin-top:4px;">Supporto, Frequenza e Generalizzazione in breve.</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn ghost" id="btnCloseLegend" type="button">Chiudi</button>
        </div>
      </div>
      <div class="sep"></div>

      <div style="display:grid; grid-template-columns:1fr; gap:10px; font-size:13px; color:var(--text);">
        <div style="padding:12px; border:1px solid var(--line); border-radius:14px; background:rgba(0,0,0,.02);">
          <b>Supporto (0‚Äì3)</b><br>
          Quanto aiuto serve per svolgere l‚Äôattivit√†.<br>
          <span class="mono">0</span> = Non riesce ‚Ä¢ <span class="mono">1</span> = Aiuto costante ‚Ä¢ <span class="mono">2</span> = Poco aiuto ‚Ä¢ <span class="mono">3</span> = Autonomo
        </div>

        <div style="padding:12px; border:1px solid var(--line); border-radius:14px; background:rgba(0,0,0,.02);">
          <b>Frequenza (F0‚ÄìF4)</b><br>
          Quanto spesso l‚Äôabilit√† si manifesta.<br>
          <span class="mono">F0</span> = Mai ‚Ä¢ <span class="mono">F1</span> = Raramente ‚Ä¢ <span class="mono">F2</span> = A volte ‚Ä¢ <span class="mono">F3</span> = Spesso ‚Ä¢ <span class="mono">F4</span> = Sempre
        </div>

        <div style="padding:12px; border:1px solid var(--line); border-radius:14px; background:rgba(0,0,0,.02);">
          <b>Generalizzazione (G0‚ÄìG3)</b><br>
          In quanti contesti l‚Äôabilit√† viene usata.<br>
          <span class="mono">G0</span> = Solo un contesto ‚Ä¢ <span class="mono">G1</span> = Pochi contesti ‚Ä¢ <span class="mono">G2</span> = Diversi contesti ‚Ä¢ <span class="mono">G3</span> = Tutti i contesti
        </div>
      

        <div style="padding:12px; border:1px solid var(--line); border-radius:14px; background:rgba(0,0,0,.02);">
          <b>Dashboard (riquadri in alto)</b><br>
          <div class="small muted" style="margin-top:6px;">
            <b>Rilevazioni</b> = numero totale di rilevazioni salvate per il profilo selezionato.<br><br>

            <b>Supporto medio (ultima)</b> = media aritmetica dei punteggi <span class="mono">Supporto 0‚Äì3</span> dell‚Äôultima rilevazione.<br>
            <span class="mono">Cosa considera</span>: tutti gli item compilati in tutte le aree (Tempo, Ambiente, Vestizione, Denaro, Apprendimenti, ecc.).<br>
            <span class="mono">Cosa NON considera</span>: Frequenza (F0‚ÄìF4), Generalizzazione (G0‚ÄìG3), Contesto e Note.<br>
            <span class="mono">Come tratta i vuoti</span>: gli item non compilati vengono esclusi dalla media (fa la media solo su quelli con un valore 0‚Äì3).<br><br>

            <b>Delta vs baseline</b> = differenza tra la media ‚ÄúSupporto medio‚Äù dell‚Äôultima rilevazione e la media ‚ÄúSupporto medio‚Äù della rilevazione baseline.<br>
            <span class="mono">Baseline</span>: la prima rilevazione disponibile nello storico del profilo (la pi√π vecchia).<br>
            <span class="mono">Formula</span>: <span class="mono">Delta = Media(ultima) ‚àí Media(baseline)</span>.<br>
            <span class="mono">Interpretazione</span>: positivo = serve meno supporto (maggior autonomia); negativo = serve pi√π supporto.<br>
</div>
        </div>

</div>
    </div>
  </div>


  <!-- POPUP ITEM AREA (rilevazione) -->
  <div id="areaModal" style="position:fixed; inset:0; background:rgba(2,6,23,.75); display:none; align-items:center; justify-content:center; padding:18px; z-index:9994;">
    <div style="max-width:1100px; width:100%; max-height:92vh; overflow:auto; background:var(--card);
                border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px 14px 10px;">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
        <div>
          <div id="areaModalTitle" style="font-weight:900; font-size:16px; color:var(--text);">Rilevazione</div>
          <div id="areaModalSub" style="margin-top:4px; color:var(--muted); font-size:12px;">Compila gli item dell‚Äôarea selezionata.</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn ghost" id="btnOpenHistory" type="button">Storico</button>
          <button class="btn ghost" id="btnCloseAreaModal" type="button">Chiudi</button>
        </div>
      </div>
      <div class="sep"></div>
      <div id="areaModalBody"></div>
    </div>
  </div>

  <!-- STORICO MODIFICHE (rilevazione) -->
  <div id="historyModal" style="position:fixed; inset:0; background:rgba(2,6,23,.75); display:none; align-items:center; justify-content:center; padding:18px; z-index:9993;">
    <div style="max-width:1100px; width:100%; max-height:92vh; overflow:auto; background:var(--card);
                border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px 14px 10px;">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
        <div>
          <div id="historyModalTitle" style="font-weight:900; font-size:16px; color:var(--text);">Storico modifiche</div>
          <div id="historyModalSub" style="margin-top:4px; color:var(--muted); font-size:12px;">Chi ha salvato, quando e cosa √® cambiato.</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn ghost" id="btnCloseHistoryModal" type="button">Chiudi</button>
        </div>
      </div>
      <div class="sep"></div>
      <div id="historyModalBody"></div>
    </div>
  </div>



  <!-- DISCLAIMER (obbligatorio) -->
  <div id="disclaimerOverlay" style="position:fixed; inset:0; background:rgba(16,24,40,.55); display:none; align-items:center; justify-content:center; padding:24px; z-index:9999;">
    <div style="max-width:760px; width:100%; background:var(--card); border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:18px 18px 14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:800; font-size:18px; color:var(--text);">Disclaimer</div>
          <div style="color:var(--muted); font-size:13px; margin-top:4px;">EduFAD ‚Äì Strumento educativo per il funzionamento adattivo</div>
        </div>
        <span style="font-family:var(--mono); font-size:12px; color:var(--muted);">v1.1</span>
      </div>
      <div style="margin-top:14px; color:var(--text); line-height:1.45; font-size:14px;">
        <ul style="margin:0; padding-left:18px;">
          <li><b>EduFAD √® uno strumento educativo</b>: non √® un test clinico, non effettua diagnosi e non sostituisce valutazioni sanitarie.</li>
          <li>I risultati rappresentano <b>indicatori operativi</b> utili a orientare osservazioni e pianificazione educativa.</li>
          <li>I dati inseriti devono essere trattati nel rispetto della <b>privacy</b> e delle regole organizzative (es. GDPR).</li>
          <li>L‚Äôuso √® riservato a <b>personale autorizzato</b> e per finalit√† educative.</li>
        </ul>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn ghost" id="btnExitDisclaimer" type="button">Esci</button>
        <button class="btn" id="btnAcceptDisclaimer" type="button">Ho capito, continua</button>
      </div>
<div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="btnBackupDownload" type="button">Scarica backup</button>
          <button class="btn danger" id="btnBackupRestore" type="button">Ripristina backup</button>
          <input id="fileBackup" type="file" accept=".edufad" style="display:none;" />
        </div>
      </div>

<div style="margin-top:10px; color:var(--muted); font-size:12px;">
        Nota: l‚Äôaccettazione viene salvata su questo browser. Se vuoi ripristinarla, cancella i dati del sito.
      </div>
    </div>
  </div>

  <!-- LOGIN (demo locale) -->
  <div id="loginOverlay" style="position:fixed; inset:0; background:#1e3a8a; display:none; align-items:center; justify-content:center; padding:24px; z-index:9998;">
    <div style="max-width:520px; width:100%; background:var(--card); border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:18px 18px 14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:800; font-size:18px; color:var(--text);">Accesso</div>
          <div style="color:var(--muted); font-size:13px; margin-top:4px;">EduFAD ‚Äì Strumento educativo per il funzionamento adattivo</div>
        </div>
        <span style="font-family:var(--mono); font-size:12px; color:var(--muted);">Login</span>
      </div>

      <div style="margin-top:14px;">
        <label class="small muted" style="display:block; margin-bottom:6px;">Username</label>
        <input id="loginUser" class="input" style="width:100%;" autocomplete="username" />
      </div>
      <div style="margin-top:10px;">
        <label class="small muted" style="display:block; margin-bottom:6px;">Password</label>
        <input id="loginPass" class="input" style="width:100%;" type="password" autocomplete="current-password" />
      </div>

      <div id="loginError" style="display:none; margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(220,38,38,.35); background:rgba(220,38,38,.08); color:#991b1b; font-size:13px;">
        Credenziali non valide.
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button class="btn" id="btnLogin" type="button">Accedi</button>
      </div>

      <div style="margin-top:10px; color:var(--muted); font-size:12px;">
        Demo locale: utenti salvati su questo browser.
      </div>
      <div style="display:flex; justify-content:flex-end; margin-top:10px;"><button class="btn ghost" id="btnResetLocal" type="button">Reset dati browser</button></div>
<div style="margin-top:8px; color:var(--muted); font-size:12px;">
        Account iniziali:
        <span style="font-family:var(--mono);">admin / admin</span> (Admin),
        <span style="font-family:var(--mono);">editor / editor</span> (Editor)
      </div>
    </div>
  </div>

  <!-- GESTIONE UTENTI (solo Admin) -->
  <div id="usersOverlay" style="position:fixed; inset:0; background:rgba(2,6,23,.65); display:none; align-items:center; justify-content:center; padding:24px; z-index:9996;">
    <div style="max-width:820px; width:100%; background:var(--card); border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:18px 18px 14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:900; font-size:18px; color:var(--text);">Gestione utenti</div>
          <div style="color:var(--muted); font-size:13px; margin-top:4px;">Crea account Editor (accesso completo a EduFAD)</div>
        </div>
        <button class="btn ghost" id="btnCloseUsers" type="button">Chiudi</button>
      </div>

      <div style="margin-top:14px; display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end;">
        <div>
          <label class="small muted" style="display:block; margin-bottom:6px;">Username (Editor)</label>
          <input id="newUser" class="input" style="width:100%;" placeholder="es. mario.rossi" />
        </div>
        <div>
          <label class="small muted" style="display:block; margin-bottom:6px;">Password</label>
          <input id="newPass" class="input" style="width:100%;" type="password" placeholder="min 4 caratteri" />
        </div>
        <button class="btn" id="btnCreateEditor" type="button" style="white-space:nowrap;">Crea Editor</button>
      </div>

      <div id="usersMsg" style="display:none; margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(30,58,138,.35); background:rgba(30,58,138,.08); color:#1e3a8a; font-size:13px;"></div>

      <div class="sep"></div>
      <div class="small muted" style="margin-bottom:8px;">Utenti salvati su questo browser (demo locale)</div>

      <div style="overflow:auto; border:1px solid var(--line); border-radius:14px;">
        <table style="width:100%; border-collapse:separate; border-spacing:0;">
          <thead>
            <tr style="background:rgba(0,0,0,.04);">
              <th style="text-align:left; padding:10px 12px; font-size:12px; color:var(--muted);">Username</th>
              <th style="text-align:left; padding:10px 12px; font-size:12px; color:var(--muted);">Ruolo</th>
              <th style="text-align:left; padding:10px 12px; font-size:12px; color:var(--muted);">Stato</th>
              <th style="text-align:right; padding:10px 12px; font-size:12px; color:var(--muted);">Azioni</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-top:12px;">
        <div>
          <div style="font-weight:900; color:var(--text);">Backup dati (.edufad)</div>
          <div class="small muted" style="margin-top:4px; max-width:560px;">
            Scarica un backup completo (profili, rilevazioni, storico, utenti, impostazioni). Il ripristino sovrascrive tutti i dati locali e riavvia l‚Äôapp.
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="btn" id="btnBackupDownload" type="button">Scarica backup</button>
          <button class="btn danger" id="btnBackupRestore" type="button">Ripristina backup</button>
          <input id="fileBackup" type="file" accept=".edufad" style="display:none;" />
        </div>
      </div>


      <div style="margin-top:10px; color:var(--muted); font-size:12px;">
        Nota: in versione online i dati utenti saranno su database e le password saranno criptate.
      </div>
    </div>
  </div>

</div>



  <div class="wrap">
    <header>
      <div class="top-left">
        <h1>Demo SPA ‚Äì Checklist Funzionamento Adattivo v1.1</h1>
        <div class="sub">Client-side ‚Ä¢ <span class="mono">localStorage</span> ‚Ä¢ Grafici Canvas ‚Ä¢ Nessun server</div>
      </div>
      <div class="top-right">
        <span class="pill"><span class="mono">Supporto</span> 0‚Äì3 ‚Ä¢ <span class="mono">F</span> F0‚ÄìF4 ‚Ä¢ <span class="mono">G</span> G0‚ÄìG3</span>
        <button class="ghost" id="btnSeed">Carica demo</button>
        <button class="ghost danger" id="btnReset">Reset dati</button>
      </div>
    
<!-- USERS BUTTON -->

<button id="btnUsers"
  style="margin-left:10px; padding:6px 12px; border-radius:999px;
         border:1px solid rgba(255,255,255,.45);
         background:rgba(255,255,255,.15);
         color:#fff; font-size:12px; font-weight:800; cursor:pointer; display:none;">
  Utenti
</button>

<!-- LOGOUT BUTTON -->
<button id="btnLogout"
  style="margin-left:10px; padding:6px 12px; border-radius:999px;
         border:1px solid rgba(255,255,255,.45);
         background:rgba(255,255,255,.15);
         color:#fff; font-size:12px; font-weight:700; cursor:pointer; display:none;">
  Esci
</button>

</header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <h2>Profili</h2>
          <button class="primary" id="btnNewProfile">+ Profilo</button>
        </div>
        <div class="bd">
          <div class="row">
            <input id="profileSearch" placeholder="Cerca profilo..." />
          </div>
          <div class="sep"></div>
          <div class="list" id="profileList"></div>
          <div class="sep"></div>

          <div class="hint">
            <b>Nota demo:</b> i dati sono salvati nel browser (localStorage). Se cambi browser/PC non li trovi.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <div style="display:flex; flex-direction:column; gap:2px; min-width:0">
            <h2 id="rightTitle">Seleziona un profilo</h2>
            <div class="small muted" id="rightSubtitle">Poi crea una rilevazione per una data.</div>
          </div>
          <div class="controls">
            <button id="btnNewAssessment" class="primary" disabled>+ Rilevazione</button>
            <button id="btnExportJSON" class="ghost" disabled>Export JSON</button>
          </div>
        </div>

        <div class="bd" id="rightPane">
          <!-- dynamic -->
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
/* ============================
   1) Master data v1.1 (AREE+ITEM)
   ============================ */
const CHECKLIST = [
  {
    key: "autonomie_personali",
    name: "Autonomie personali",
    items: [
      "Si lava le mani completando la routine funzionale",
      "Si lava il viso completando l‚Äôazione",
      "Si lava i denti completando la routine prevista",
      "Indossa e toglie i capi di abbigliamento quotidiani",
      "Gestisce i sistemi di chiusura dei vestiti",
      "Consuma un pasto utilizzando le posate",
      "Beve utilizzando il bicchiere senza rovesciare il contenuto",
      "Gestisce l‚Äôigiene dopo l‚Äôuso dei servizi igienici",
    ],
  },
  {
    key: "gestione_tempo",
    name: "Gestione del tempo",
    items: [
      "Avvia un‚Äôattivit√† all‚Äôorario stabilito",
      "Conclude un‚Äôattivit√† entro il tempo previsto",
      "Passa da un‚Äôattivit√† a un‚Äôaltra rispettando la consegna temporale",
      "Segue una routine giornaliera strutturata",
      "Utilizza un supporto temporale per orientarsi nella giornata",
      "Attende un turno o un evento rispettando il tempo indicato",
      "Gestisce un breve tempo libero senza disorganizzarsi",
    ],
  },
  {
    key: "gestione_denaro",
    name: "Gestione del denaro",
    items: [
      "Riconosce monete e banconote di uso comune",
      "Associa il denaro al valore richiesto per un acquisto semplice",
      "Effettua un pagamento in contanti per un acquisto semplice",
      "Riceve e controlla il resto dopo un pagamento",
      "Conserva il denaro durante l‚Äôattivit√†",
      "Rispetta un limite di spesa indicato",
      "Riconosce la necessit√† di pagare per ottenere un bene o servizio",
    ],
  },
  {
    key: "gestione_ambiente",
    name: "Gestione dell‚Äôambiente",
    items: [
      "Riordina il proprio spazio personale dopo l‚Äôattivit√†",
      "Ripone gli oggetti personali nel luogo previsto",
      "Utilizza gli oggetti in base alla loro funzione",
      "Restituisce gli oggetti condivisi al termine dell‚Äôuso",
      "Rispetta le regole di utilizzo degli spazi comuni",
      "Mantiene in ordine uno spazio comune dopo l‚Äôattivit√†",
      "Si muove negli ambienti rispettando i percorsi indicati",
    ],
  },
  {
    key: "autonomie_domestiche",
    name: "Autonomie domestiche",
    items: [
      "Prepara uno spuntino semplice seguendo i passaggi essenziali",
      "Apparecchia la tavola per un pasto semplice",
      "Sparecchia la tavola al termine del pasto",
      "Lava stoviglie utilizzando acqua e detergente",
      "Pulisce una superficie dopo l‚Äôattivit√†",
      "Utilizza un elettrodomestico semplice in modo sicuro",
      "Ripone il bucato pulito nel luogo previsto",
    ],
  },

  {
    key: "apprendimenti",
    name: "Apprendimenti",
    items: [
      "Comprende una consegna semplice (orale o scritta) e la esegue",
      "Legge parole o frasi brevi funzionali al compito",
      "Copia correttamente una parola o una frase breve dal modello",
      "Scrive parole o frasi brevi in modo leggibile",
      "Utilizza il quaderno (righe/spazi) in modo adeguato al compito",
      "Esegue calcoli semplici con numeri naturali (addizioni/sottrazioni)",
      "Risolve un problema semplice con supporto (schema, immagini o guida)",
      "Organizza il materiale scolastico necessario per la lezione (libro/quaderno/astuccio)",
    ],
  },
  {
    key: "autonomie_sociali",
    name: "Autonomie sociali",
    items: [
      "Chiede aiuto in modo comprensibile quando necessario",
      "Esprime un bisogno o una richiesta in modo funzionale",
      "Rispetta il turno durante un‚Äôattivit√† condivisa",
      "Segue una regola sociale esplicita indicata dall‚Äôadulto",
      "Avvia un‚Äôinterazione sociale semplice con un pari o un adulto",
      "Mantiene un‚Äôinterazione sociale semplice fino alla conclusione",
      "Accetta una richiesta o un limite comunicato dall‚Äôadulto",
    ],
  },
];

const SUPPORT_LEVELS = [0,1,2,3];
const FREQ_LEVELS = ["F0","F1","F2","F3","F4"];
const GEN_LEVELS  = ["G0","G1","G2","G3"];
const CONTEXTS    = ["casa","scuola","centro","negozio","altro"];

/* ============================
   2) Storage layer (localStorage)
   ============================ */
const STORAGE_KEY = "cfa_demo_v11";
const nowISO = () => new Date().toISOString();
const uid = () => Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return { version: "demo-v1.1", profiles: [], assessments: [] };
  try { return JSON.parse(raw); } catch { return { version: "demo-v1.1", profiles: [], assessments: [] }; }
}
function saveState(state){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
let STATE = loadState();


function downloadBackupEduFAD(){
  const sess = getSession();
  if(!sess || sess.role!=="admin"){ alert("Solo Admin."); return; }

  const keys = [STORAGE_KEY, USERS_KEY, SESSION_KEY, KEY];
  const data = {};
  keys.forEach(k=>{ data[k] = localStorage.getItem(k); });

  const payload = {
    kind: "EduFAD_BACKUP",
    version: 1,
    exportedAt: new Date().toISOString(),
    keys: keys,
    data: data
  };

  const blob = new Blob([JSON.stringify(payload)], {type:"application/octet-stream"});
  const a = document.createElement("a");
  const ymd = fmtDate(new Date().toISOString());
  a.download = `backup_edufad_${ymd}.edufad`;
  a.href = URL.createObjectURL(blob);
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

function restoreBackupEduFAD(file){
  const sess = getSession();
  if(!sess || sess.role!=="admin"){ alert("Solo Admin."); return; }
  if(!file){ return; }

  const r = new FileReader();
  r.onload = ()=>{
    try{
      const txt = String(r.result||"");
      const payload = JSON.parse(txt);

      if(!payload || payload.kind!=="EduFAD_BACKUP" || !payload.data){
        alert("File backup non valido.");
        return;
      }

      const ok1 = confirm("Ripristinare il backup? Questa operazione sovrascrive TUTTI i dati locali.");
      if(!ok1) return;
      const ok2 = confirm("Conferma finale: continuare con il ripristino e riavviare l‚Äôapp?");
      if(!ok2) return;

      // Write items
      const keys = payload.keys || Object.keys(payload.data);
      keys.forEach(k=>{
        const v = payload.data[k];
        if(v === null || v === undefined){
          localStorage.removeItem(k);
        }else{
          localStorage.setItem(k, v);
        }
      });

      alert("Ripristino completato. L'app verr√† riavviata.");
      // Riavvio automatico (richiesto)
      window.location.reload();
    }catch(e){
      alert("Errore: il backup non √® leggibile.");
    }
  };
  r.readAsText(file);
}


/* ============================
   3) UI state
   ============================ */
let selectedProfileId = null;
let selectedAssessmentId = null;
let activeAreaKey = null;

/* ============================
   4) Helpers
   ============================ */
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 2200);
}
function fmtDate(iso){
  const d = new Date(iso);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function getAssessmentById(id){
  // In EduFAD v1.1 le rilevazioni sono anche in STATE.assessments
  const list = (STATE && Array.isArray(STATE.assessments)) ? STATE.assessments : [];
  for(const a of list){
    if(a && a.id === id) return a;
  }
  // fallback: vecchia struttura (se presente)
  for(const p of (STATE.profiles || [])){
    for(const a of (p.assessments || [])){
      if(a && a.id === id) return a;
    }
  }
  return null;
}

function getProfile(id){ return STATE.profiles.find(p=>p.id===id) || null; }
function getAssessmentsByProfile(pid){
  return STATE.assessments.filter(a=>a.profileId===pid).sort((a,b)=> (a.dateISO > b.dateISO ? -1 : 1));
}
function getAssessment(id){ return STATE.assessments.find(a=>a.id===id) || null; }

function ensureResponseMap(assess){
  // responses: { areaKey: { itemIndex: {support,freq,gen,context,note} } }
  if(!assess.responses) assess.responses = {};
  for(const area of CHECKLIST){
    if(!assess.responses[area.key]) assess.responses[area.key] = {};
    for(let i=0;i<area.items.length;i++){
      if(!assess.responses[area.key][i]){
        assess.responses[area.key][i] = { support:null, freq:null, gen:null, context:null, note:"" };
      }
    }
  }
}

/* ============================
   5) Rendering: Profiles list
   ============================ */
function renderProfiles(){
  const q = (document.getElementById("profileSearch").value || "").toLowerCase().trim();
  const list = document.getElementById("profileList");
  list.innerHTML = "";

  const profiles = [...STATE.profiles].sort((a,b)=> (a.name.localeCompare(b.name)));
  const filtered = q ? profiles.filter(p => p.name.toLowerCase().includes(q)) : profiles;

  if(filtered.length === 0){
    list.innerHTML = `<div class="muted small">Nessun profilo. Clicca ‚Äú+ Profilo‚Äù o ‚ÄúCarica demo‚Äù.</div>`;
    return;
  }

  for(const p of filtered){
    const assessments = getAssessmentsByProfile(p.id);
    const latest = assessments[0];
    const el = document.createElement("div");
    el.className = "item";
    el.onclick = () => selectProfile(p.id);

    el.innerHTML = `
      <div class="left">
        <div class="title">${escapeHtml(p.name)}</div>
        <div class="meta">
          ${assessments.length} rilevazioni
          ${latest ? " ‚Ä¢ ultima: " + escapeHtml(fmtDate(latest.dateISO)) : ""}
        </div>
      </div>
      <div class="right">
        <span class="badge">${selectedProfileId===p.id ? "Selezionato" : "Apri"}</span>
      </div>
    `;
    list.appendChild(el);
  }
}

/* ============================
   6) Rendering: Right pane
   ============================ */
function selectProfile(pid){
  selectedProfileId = pid;
  selectedAssessmentId = null;
  activeAreaKey = CHECKLIST[0].key;
  const p = getProfile(pid);
  document.getElementById("rightTitle").textContent = p ? (p.name + (p.dob ? (" ‚Ä¢ " + formatAge(p.dob)) : "")) : "Profilo";
  document.getElementById("rightSubtitle").textContent = p ? `ID: ${p.id}` : "";
  document.getElementById("btnNewAssessment").disabled = !p;
  document.getElementById("btnExportJSON").disabled = !p;
  renderRightPane();
  renderProfiles();
}

function renderRightPane(){
  const pane = document.getElementById("rightPane");
  const p = getProfile(selectedProfileId);
  if(!p){
    pane.innerHTML = `
      <div class="hint">
        <b>Come usare la demo:</b>
        <ol>
          <li>Crea o carica un profilo.</li>
          <li>Apri il profilo ‚Üí ‚Äú+ Rilevazione‚Äù.</li>
          <li>Compila supporto (0‚Äì3), F, G, contesto e note.</li>
          <li>Guarda i grafici nel tempo.</li>
        </ol>
        <div class="sep"></div>
        <div class="hint">
          <b>Decisioni v1.1 integrate:</b>
          supporto come scala principale; frequenza e generalizzazione separate; azione completa; errore per impatto funzionale (note); monitoraggio nel tempo.
        </div>
      </div>
    `;
    return;
  }

  const assessments = getAssessmentsByProfile(p.id);
  const selected = selectedAssessmentId ? getAssessment(selectedAssessmentId) : null;

  pane.innerHTML = `
    <div class="two-col">
      <div class="card" style="box-shadow:none">
        <div class="hd"><h2>Rilevazioni</h2><span class="badge">${assessments.length}</span></div>
        <div class="bd">
          ${renderAssessmentsListHTML(assessments)}
        </div>
      </div>
      <div class="card" style="box-shadow:none">
        <div class="hd"><h2>Dashboard</h2><span class="badge">Canvas</span></div>
        <div class="bd">
          ${renderDashboardHTML(p.id)}
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="card" style="box-shadow:none">
      <div class="hd">
        <h2>${selected ? "Editor rilevazione" : "Seleziona una rilevazione"}</h2>
        <div class="controls">
          ${selected ? `<span class="badge mono">${escapeHtml(fmtDate(selected.dateISO))}</span>` : ""}
          ${selected ? `<button class="danger" id="btnDeleteAssessment">Elimina</button>` : ""}
        </div>
      </div>
      <div class="bd" id="editorArea">
        ${selected ? renderAssessmentEditorHTML(selected) : `<div class="muted small">Seleziona una rilevazione a sinistra oppure creane una nuova.</div>`}
      </div>
    </div>
  `;

  // wire events
  if(selected){
    document.getElementById("btnDeleteAssessment").onclick = () => deleteAssessmentSoft(selected.id);
    bindEditorEvents(selected.id);
  }
  bindDashboardCanvases(p.id);
}

function renderAssessmentsListHTML(assessments){
  if(assessments.length===0){
    return `
      <div class="muted small">Nessuna rilevazione. Clicca ‚Äú+ Rilevazione‚Äù.</div>
      <div class="sep"></div>
      <div class="hint">
        Suggerimento: fai baseline oggi e poi rivalutazioni ogni 8‚Äì12 settimane.
      </div>
    `;
  }
  return `
    <div class="list">
      ${assessments.map(a=>{
        const isSel = a.id===selectedAssessmentId;
        const avg = computeAssessmentAvgSupport(a);
        return `
          <div class="item" onclick="window.__selectAssessment('${a.id}')">
            <div class="left">
              <div class="title">${escapeHtml(fmtDate(a.dateISO))}</div>
              <div class="meta">Supporto medio: <span class="mono">${avg !== null ? avg.toFixed(2) : "‚Äî"}</span></div>
            </div>
            <div class="right">
              <span class="badge">${isSel ? "Aperta" : "Apri"}</span>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}
window.__selectAssessment = (aid) => {
  selectedAssessmentId = aid;
  activeAreaKey = CHECKLIST[0].key;
  renderRightPane();
};


function fmtValProfile(k, v){
  if(v===null || v===undefined) return "";
  if(k==="dob"){
    return String(v) + (formatAge(v) ? (" ‚Ä¢ " + formatAge(v)) : "");
  }
  if(typeof v === "boolean") return v ? "S√¨" : "No";
  if(typeof v === "number") return String(v);
  if(typeof v === "string") return v;
  try{ return JSON.stringify(v); }catch(e){ return String(v); }
}

function labelProfileKey(k){
  const map = {
    name: "Nome",
    dob: "Data di nascita",
    createdAt: "Creato il",
    updatedAt: "Aggiornato il"
  };
  return map[k] || k;
}

function renderProfileInfoCard(p){
  if(!p) return "";
  const hidden = new Set(["id","assessments","history","_dirty"]);
  const keys = Object.keys(p).filter(k=>!hidden.has(k));
  const priority = ["name","dob","createdAt","updatedAt"];
  const ordered = [...priority.filter(k=>keys.includes(k)), ...keys.filter(k=>!priority.includes(k))];

  const rows = ordered.map(k=>{
    const val = fmtValProfile(k, p[k]);
    if(val==="") return "";
    return `
      <div style="display:flex; gap:10px; align-items:flex-start; padding:8px 0; border-top:1px solid var(--line);">
        <div style="min-width:170px; font-size:12px; color:var(--muted); font-weight:800;">${escapeHtml(labelProfileKey(k))}</div>
        <div style="flex:1; font-size:13px; color:var(--text); font-weight:800; word-break:break-word;">${escapeHtml(val)}</div>
      </div>`;
  }).join("");

  return `
    <div class="card" style="padding:12px; margin-top:12px;">
      <div style="font-weight:900; color:var(--text);">Scheda profilo</div>
      <div class="small muted" style="margin-top:4px;">Tutte le informazioni associate al profilo selezionato.</div>
      <div style="margin-top:8px;">
        ${rows || '<div class="small muted">Nessuna informazione disponibile.</div>'}
      </div>
    </div>
  `;
}

function renderDashboardHTML(profileId){
  const p = getProfile(profileId);
// KPI
  const as = getAssessmentsByProfile(profileId);
  const latest = as[0];
  const baseline = as.length ? as[as.length-1] : null;

  const latestAvg = latest ? computeAssessmentAvgSupport(latest) : null;
  const baseAvg = baseline ? computeAssessmentAvgSupport(baseline) : null;
  const delta = (latestAvg!==null && baseAvg!==null) ? (latestAvg - baseAvg) : null;

  return `
${renderProfileInfoCard(p)}

    <div class="kpi">
      <div class="box">
        <div class="v mono">${as.length}</div>
        <div class="l">Rilevazioni</div>
      </div>
      <div class="box">
        <div class="v mono">${latestAvg!==null ? latestAvg.toFixed(2) : "‚Äî"}</div>
        <div class="l">Supporto medio (ultima)</div>
      </div>
      <div class="box">
        <div class="v mono">${delta!==null ? (delta>0? "+" : "") + delta.toFixed(2) : "‚Äî"}</div>
        <div class="l">Delta vs baseline</div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="small muted">Trend supporto medio (0‚Äì3) nel tempo</div>
    
</div>

<canvas id="cvTrend"></canvas>
    <div class="sep"></div>
    <div class="small muted">Trend supporto medio per area (0‚Äì3) nel tempo</div>
    <div style="display:flex; gap:10px; align-items:center; margin:8px 0 10px;">
      <div class="small muted" style="min-width:90px;">Area</div>
      <select id="selTrendArea" class="input" style="flex:1; max-width:340px;">
        ${CHECKLIST.map(a=>`<option value="${a.key}">${escapeHtml(a.name)}</option>`).join("")}
      </select>
    </div>
    <canvas id="cvTrendArea"></canvas>

    <div class="sep"></div>
    <div class="small muted">Supporto medio per area (ultima rilevazione)</div>
    <canvas id="cvAreas"></canvas>
    
  `;
}

/* ============================
   7) Assessment editor
   ============================ */
function renderAssessmentEditorHTML(assess){
  ensureAssessmentSummary(assess);

  ensureResponseMap(assess);
  const tabs = CHECKLIST.map(a => {
    const on = (a.key===activeAreaKey) ? "active" : "";
    return `<div class="tab ${on}" onclick="window.__setArea('${a.key}')">${escapeHtml(a.name)}</div>`;
  }).join("");

  return `
    <div class="row">
      <div>
        <div class="small muted">Aree</div>
        <div class="tabs">${tabs}</div>
        <div class="small muted" style="margin-top:8px;">Clicca un‚Äôarea per aprire gli item in pop‚Äëup.</div>
      </div>
      <div class="row tight" style="justify-content:flex-end">
        <span class="badge mono">Autosave: manuale (Salva)</span>
      </div>
    </div>
    <div class="sep"></div>
    <div class="hint">
      Seleziona un‚Äôarea per compilare Supporto (0‚Äì3), Frequenza (F0‚ÄìF4), Generalizzazione (G0‚ÄìG3), contesto e note.
    </div>

    <div class="sep"></div>
    <div class="card" style="box-shadow:none; border:1px solid var(--line);">
      <div class="hd" style="padding:10px 12px;">
        <h2 style="font-size:14px;">Resoconto automatico</h2>
        <div class="controls">
          <button class="btn ghost" id="btnRegenSummary" type="button">Rigenera</button>
          <button class="btn" id="btnDownloadPlanPDF" type="button">Scarica Piano Educativo (PDF)</button>
        </div>
      </div>
      <div class="bd" style="padding:10px 12px;">
        <textarea id="summaryBox" readonly style="width:100%; min-height:160px; resize:vertical; padding:10px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.6); color:var(--text); font-weight:700;">${escapeHtml(assess.summaryText || "")}</textarea>
        <div class="small muted" style="margin-top:8px;">Il resoconto viene aggiornato al salvataggio. Puoi rigenerarlo in qualsiasi momento.</div>
      </div>
    </div>

  `;
}
window.__setArea = (k) => { activeAreaKey = k; if(window.__openAreaModal) window.__openAreaModal(k); };

function renderRadioGroup(name, values, current){
  return `
    <div class="radio-group" data-radios="${name}">
      ${values.map(v=>{
        const on = (current===v) ? "on" : "";
        return `<div class="radio ${on}" data-v="${v}">${escapeHtml(String(v))}</div>`;
      }).join("")}
    </div>
  `;
}

function bindEditorEvents(assessmentId){
  const assess = getAssessment(assessmentId);
  if(!assess) return;
  ensureResponseMap(assess);

  // radio clicks
  document.querySelectorAll("[data-radios]").forEach(group=>{
    group.addEventListener("click", (e)=>{
      const t = e.target;
      if(!t.classList.contains("radio")) return;
      const groupName = group.getAttribute("data-radios");
      const vRaw = t.getAttribute("data-v");
      let v = vRaw;
      // support is numeric
      if(groupName.startsWith("s-")) v = Number(vRaw);

      // parse groupName: "<type>-<areaKey>-<idx>"
      const parts = groupName.split("-");
      const type = parts[0];
      const areaKey = parts.slice(1, parts.length-1).join("-");
      const idx = Number(parts[parts.length-1]);

      const resp = assess.responses[areaKey][idx];

      if(type==="s") resp.support = (resp.support===v ? null : v);
      if(type==="f") resp.freq = (resp.freq===v ? null : v);
      if(type==="g") resp.gen = (resp.gen===v ? null : v);

      // update UI: toggle
      group.querySelectorAll(".radio").forEach(r=>r.classList.remove("on"));
      if((type==="s" && resp.support!==null) || (type==="f" && resp.freq!==null) || (type==="g" && resp.gen!==null)){
        // set on current
        const currentVal = (type==="s") ? resp.support : (type==="f") ? resp.freq : resp.gen;
        const el = group.querySelector(`.radio[data-v="${String(currentVal)}"]`);
        if(el) el.classList.add("on");
      }

      // mark dirty
      assess._dirty = true;
    });
  });

  // context changes
  document.querySelectorAll("select[data-ctx]").forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const [areaKey, idxStr] = sel.getAttribute("data-ctx").split(":");
      const idx = Number(idxStr);
      assess.responses[areaKey][idx].context = sel.value || null;
      assess._dirty = true;
    });
  });

  // note changes
  document.querySelectorAll("textarea[data-note]").forEach(ta=>{
    ta.addEventListener("input", ()=>{
      const [areaKey, idxStr] = ta.getAttribute("data-note").split(":");
      const idx = Number(idxStr);
      assess.responses[areaKey][idx].note = ta.value || "";
      assess._dirty = true;
    });
  });

  // rigenera resoconto
  const btnRegen = document.getElementById("btnRegenSummary");
  if(btnRegen){
    btnRegen.onclick = ()=>{
      try{
        assess.summaryText = generateAssessmentSummary(assess, getProfile(assess.profileId));
        const box = document.getElementById("summaryBox");
        if(box) box.value = assess.summaryText || "";
        toast("Resoconto rigenerato.");
      }catch(e){ toast("Impossibile rigenerare il resoconto."); }
    };
  }
  // scarica piano educativo (PDF via stampa)
  const btnPlan = document.getElementById("btnDownloadPlanPDF");
  if(btnPlan){
    btnPlan.onclick = ()=>{
      try{ window.openEducationPlanPrint(assess.id); }catch(e){ alert("Impossibile generare il piano."); }
    };
  }



  // save button
  document.getElementById("btnSaveAssessment").onclick = ()=>{
    // registra storico (prima di salvare) sull'area corrente
    try{ if(window.__recordHistoryForSave) window.__recordHistoryForSave(assess, activeAreaKey); }catch(e){}
    // aggiorna resoconto automatico
    try{ assess.summaryText = generateAssessmentSummary(assess, getProfile(assess.profileId)); }catch(e){}
    assess.updatedAt = nowISO();
    assess._dirty = false;
    saveState(STATE);
    toast("Salvataggio completato correttamente.");
    renderRightPane();
    renderProfiles();
  };
}

/* ============================
   8) Create/Edit entities
   ============================ */


function calcAgeYears(dobISO){
  // dobISO: YYYY-MM-DD
  if(!dobISO) return null;
  const m = String(dobISO).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const y = parseInt(m[1],10), mo = parseInt(m[2],10), d = parseInt(m[3],10);
  const today = new Date();
  let age = today.getFullYear() - y;
  const hasHadBirthday = (today.getMonth()+1 > mo) || ((today.getMonth()+1 === mo) && (today.getDate() >= d));
  if(!hasHadBirthday) age -= 1;
  return age;
}

function formatAge(dobISO){
  const a = calcAgeYears(dobISO);
  if(a===null || isNaN(a)) return "";
  return a + " anni";
}

function normalizeBaseName(n){
  // Rimuove eventuale codice finale (A#) e normalizza spazi
  return String(n||"").replace(/\s*\(A\d+\)\s*$/i,"").trim();
}

function nextOmonimiaCode(baseName){
  const base = normalizeBaseName(baseName);
  const existing = STATE.profiles
    .map(p=>p.name||"")
    .filter(n=>normalizeBaseName(n).toLowerCase() === base.toLowerCase());

  if(existing.length === 0) return ""; // nessuna omonimia

  // Trova i codici gi√† usati (A1, A2, ...)
  const used = new Set();
  existing.forEach(n=>{
    const m = String(n).match(/\(A(\d+)\)\s*$/i);
    if(m) used.add(parseInt(m[2],10));
    else used.add(1); // se esiste un nome senza codice, consideriamo A1 occupato
  });

  // Primo numero libero a partire da 1
  let k = 1;
  while(used.has(k)) k++;
  return `(A${k})`;
}

function newProfile(){
  const name = prompt("Nome profilo (es. Giosu√® / Studente 1):");
  if(!name || !name.trim()) return;
  const baseName = name.trim();
  const code = nextOmonimiaCode(baseName);
  const finalName = code ? (normalizeBaseName(baseName) + " " + code) : normalizeBaseName(baseName);

  // Data di nascita obbligatoria (YYYY-MM-DD) per calcolo et√†
  let dob = prompt("Data di nascita (YYYY-MM-DD):");
  if(!dob || !dob.trim()) return;
  dob = dob.trim();
  if(!/^\d{4}-\d{2}-\d{2}$/.test(dob)){
    alert("Formato non valido. Usa YYYY-MM-DD (es. 2012-05-07).");
    return;
  }
  if(calcAgeYears(dob) === null){
    alert("Data di nascita non valida.");
    return;
  }

const p = { id: uid(), name: finalName, dob: dob, createdAt: nowISO(), updatedAt: nowISO() };
  STATE.profiles.push(p);
  saveState(STATE);
  toast("Profilo creato");
  renderProfiles();
  selectProfile(p.id);
}

function newAssessment(){
  const p = getProfile(selectedProfileId);
  if(!p) return;

  const date = prompt("Data rilevazione (YYYY-MM-DD):", new Date().toISOString().slice(0,10));
  if(!date) return;
  if(!/^\d{4}-\d{2}-\d{2}$/.test(date.trim())){ toast("Formato data non valido"); return; }

  const dateISO = date.trim() + "T00:00:00.000Z";
  // vincolo: una per profilo + data
  const exists = STATE.assessments.find(a=>a.profileId===p.id && a.dateISO.startsWith(date.trim()));
  if(exists){ toast("Esiste gi√† una rilevazione per questa data"); selectedAssessmentId = exists.id; renderRightPane(); return; }

  const a = {
    id: uid(),
    profileId: p.id,
    dateISO,
    createdAt: nowISO(),
    updatedAt: nowISO(),
    responses: {}
  };
  ensureResponseMap(a);
  STATE.assessments.push(a);
  saveState(STATE);
  toast("Rilevazione creata");
  selectedAssessmentId = a.id;
  activeAreaKey = CHECKLIST[0].key;
  renderRightPane();
  renderProfiles();
}

function deleteAssessmentSoft(aid){
  const a = getAssessment(aid);
  if(!a) return;
  const ok = confirm("Eliminare questa rilevazione? (demo: soft-delete)");
  if(!ok) return;
  // soft-delete demo: remove from list but keep in state with flag
  a.isDeleted = true;
  a.deletedAt = nowISO();
  saveState(STATE);
  toast("Eliminata (soft)");
  // auto-select next available
  const remaining = getAssessmentsByProfile(a.profileId).filter(x=>!x.isDeleted);
  selectedAssessmentId = remaining[0]?.id || null;
  renderRightPane();
  renderProfiles();
}

/* ============================
   9) Computations & charts
   ============================ */

function safeNum(v){ return (v===0||v===1||v===2||v===3) ? v : null; }

function generateAssessmentSummary(assess, profile){
  if(!assess) return "";
  ensureResponseMap(assess);
  const p = profile || (assess.profileId ? getProfile(assess.profileId) : null);

  // Copertura compilazione
  let total=0, filled=0, lowCount=0, highCount=0;
  for(const area of CHECKLIST){
    const map = assess.responses[area.key];
    for(let i=0;i<area.items.length;i++){
      total++;
      const v = safeNum(map[i]?.support);
      if(v!==null){
        filled++;
        if(v<=1) lowCount++;
        if(v===3) highCount++;
      }
    }
  }
  const avgAll = computeAssessmentAvgSupport(assess);
  const coverPct = total ? Math.round((filled/total)*100) : 0;

  // Medie per area (Supporto)
  const areaAvg = computeAssessmentAreaAvg(assess);
  const areaRows = CHECKLIST.map(a=>({key:a.key, name:a.name, avg: areaAvg[a.key]}))
    .filter(r=>r.avg!==null)
    .sort((a,b)=> (b.avg||0)-(a.avg||0));

  // Aree di forza / aree prioritarie (in base al numero di aree con punteggio valido)
  let top = [];
  let bottom = [];
  if(areaRows.length >= 3){
    top = areaRows.slice(0,2);      // pi√π alte
    bottom = areaRows.slice(-2);    // pi√π basse
  }else if(areaRows.length === 2){
    top = [areaRows[0]];            // pi√π alta
    bottom = [areaRows[1]];         // pi√π bassa
  }else if(areaRows.length === 1){
    top = [areaRows[0]];
    bottom = [];
  }
// pi√π basse

  // Costruzione testo (formale, sintetico)
  const parts = [];
  const dateStr = fmtDate(assess.dateISO);
  const name = p?.name ? p.name : "Profilo";
  const ageStr = (p?.dob && formatAge(p.dob)) ? formatAge(p.dob) : "";

  parts.push(`Resoconto rilevazione del ${dateStr}`);
  parts.push(`Profilo: ${name}${ageStr ? " ("+ageStr+")" : ""}.`);
  parts.push(`Compilazione: ${filled}/${total} item (${coverPct}%).`);

  if(avgAll!==null){
    parts.push(`Indice sintetico (Supporto medio complessivo): ${avgAll.toFixed(2)} su 3.`);
  }else{
    parts.push(`Indice sintetico: non calcolabile (assenza di punteggi Supporto).`);
  }

  // Interpretazione prudente
  if(avgAll!==null){
    if(avgAll>=2.5) parts.push("Quadro complessivamente positivo: prevale una buona autonomia con supporti limitati.");
    else if(avgAll>=1.8) parts.push("Quadro intermedio: autonomia parziale con necessit√† di supporto variabile a seconda delle situazioni.");
    else parts.push("Quadro di fragilit√†: emerge un bisogno di supporto frequente per l‚Äôesecuzione autonoma delle attivit√†.");
  }

  // Aree di forza / aree prioritarie
  if(top.length){
    parts.push(`${top.length>1 ? "Aree di forza" : "Area di forza"} (Supporto medio pi√π alto): ${top.map(x=>`${x.name} (${x.avg.toFixed(2)})`).join(", ")}.`);
  }
  if(bottom.length){
    parts.push(`${bottom.length>1 ? "Aree prioritarie" : "Area prioritaria"} (Supporto medio pi√π basso): ${bottom.map(x=>`${x.name} (${x.avg.toFixed(2)})`).join(", ")}.`);
  }

  // Indicatori item
  parts.push(`Indicatori: item con supporto basso (0‚Äì1): ${lowCount}; item con autonomia (3): ${highCount}.`);

  parts.push("Nota: il presente resoconto √® generato automaticamente sulla base dei punteggi inseriti (Supporto 0‚Äì3).");

  parts.push("\n---\n");
  parts.push(generateClinicalNarrative(assess, p));

  return parts.join("\n");
}


function generateClinicalNarrative(assess, profile){
  if(!assess) return "";
  ensureResponseMap(assess);
  const p = profile || (assess.profileId ? getProfile(assess.profileId) : null);

  const avgAll = computeAssessmentAvgSupport(assess);
  const areaAvg = computeAssessmentAreaAvg(assess);

  // Build ordered areas by avg (desc)
  const rows = CHECKLIST.map(a=>({name:a.name, key:a.key, avg: areaAvg[a.key]}))
    .filter(r=>r.avg!==null)
    .sort((a,b)=> (b.avg||0)-(a.avg||0));

  let strength = null, priority = null;
  if(rows.length >= 1) strength = rows[0];
  if(rows.length >= 2) priority = rows[rows.length-1];

  // Indicators
  let total=0, filled=0, low=0;
  for(const area of CHECKLIST){
    const map = assess.responses[area.key];
    for(let i=0;i<area.items.length;i++){
      total++;
      const v = (map[i] && map[i].support);
      if(v===0||v===1||v===2||v===3){
        filled++;
        if(v<=1) low++;
      }
    }

function computeAreaItemLists(assess, areaKey){
  ensureResponseMap(assess);
  const area = CHECKLIST.find(a=>a.key===areaKey);
  if(!area) return {strength:[], weak:[], all:[]};
  const map = assess.responses[areaKey] || {};
  const all = [];
  const strength = [];
  const weak = [];
  for(let i=0;i<area.items.length;i++){
    const it = area.items[i];
    const r = map[i] || {};
    const s = (r.support===0||r.support===1||r.support===2||r.support===3) ? r.support : null;
    const f = (r.freq===0||r.freq===1||r.freq===2||r.freq===3||r.freq===4) ? r.freq : null;
    const g = (r.gen===0||r.gen===1||r.gen===2||r.gen===3) ? r.gen : null;
    if(s===null && f===null && g===null) continue; // non compilato
    const row = {i:i+1, label: it.label || it, support:s, freq:f, gen:g};
    all.push(row);
    if(s!==null && s>=2) strength.push(row);
    if(s!==null && s<=1) weak.push(row);
  }
  return {strength, weak, all};
}


function buildDiaryNarrative(assess, profile){
  // DIARIO EDUCATIVO (SEZIONE DISCORSIVA) ‚Äî interpretativo, fluido, senza numeri/punteggi.
  // TUTTO IL RESTO DELL'APP RESTA INVARIATO.
  ensureResponseMap(assess);

  const p = profile || (assess.profileId ? getProfile(assess.profileId) : null);
  const name = p?.name || "L‚Äôalunno";

  function supportVal(r){
    return (r && (r.support===0 || r.support===1 || r.support===2 || r.support===3)) ? r.support : null;
  }

  function norm(s){
    s = (s || "").trim();
    if(!s) return "";
    if(s.endsWith(".")) s = s.slice(0,-1);
    return s;
  }

  // Converte il primo verbo (quando possibile) in infinito per frasi naturali (no "a riconosce").
  function toInfinitiveItem(label){
    label = norm(label);
    if(!label) return "";
    const parts = label.split(/\s+/);
    const v = (parts[0] || "").toLowerCase();

    const dict = {
      "chiede":"chiedere",
      "rispetta":"rispettare",
      "segue":"seguire",
      "avvia":"avviare",
      "mantiene":"mantenere",
      "accetta":"accettare",
      "riconosce":"riconoscere",
      "associa":"associare",
      "effettua":"effettuare",
      "gestisce":"gestire",
      "beve":"bere",
      "usa":"usare",
      "utilizza":"utilizzare",
      "completa":"completare",
      "organizza":"organizzare",
      "prepara":"preparare",
      "controlla":"controllare",
      "richiede":"richiedere",
      "comprende":"comprendere"
    };

    let inf = dict[v] || "";

    // fallback leggero (non perfetto ma meglio di niente)
    if(!inf){
      if(v.endsWith("a")) inf = v.slice(0,-1) + "are";
      else if(v.endsWith("e")) inf = v.slice(0,-1) + "ere";
      else if(v.endsWith("i")) inf = v.slice(0,-1) + "ire";
    }

    if(!inf) return label.charAt(0).toLowerCase() + label.slice(1);

    const rest = parts.slice(1).join(" ");
    const phrase = (inf + (rest ? " " + rest : "")).trim();
    return phrase.charAt(0).toLowerCase() + phrase.slice(1);
  }

  function unique(arr){
    const out = [];
    const seen = new Set();
    for(const x of arr){
      const k = (x||"").trim().toLowerCase();
      if(!k || seen.has(k)) continue;
      seen.add(k);
      out.push(x);
    }
    return out;
  }

  function joinNatural(arr){
    if(!arr || !arr.length) return "";
    if(arr.length === 1) return arr[0];
    if(arr.length === 2) return arr[0] + " e " + arr[1];
    return arr.slice(0,-1).join(", ") + " e " + arr[arr.length-1];
  }

  function pickLabels(areaKey, mode){
    const area = CHECKLIST.find(a => a.key === areaKey);
    if(!area) return [];
    const map = assess.responses[areaKey] || {};
    const out = [];

    for(let i=0;i<area.items.length;i++){
      const it = area.items[i];
      const r = map[i] || {};
      const s = supportVal(r);
      if(s === null) continue;

      const label = norm((it && it.label) ? it.label : String(it));
      if(!label) continue;

      if(mode === "strength" && s >= 2) out.push(label);
      if(mode === "priority" && s <= 1) out.push(label);
    }
    return unique(out);
  }

  // Micro-mappe semantiche per rendere il testo ‚Äúinterpretativo‚Äù
  function semanticHeadline(areaName, items){
    const text = items.join(" | ").toLowerCase();

    // Denaro
    if(/monet|banconot|pag|acquist|spes|costo|resto/.test(text)) {
      return `una discreta autonomia nella gestione del denaro e di semplici situazioni di acquisto`;
    }
    // Igiene / autonomie personali
    if(/igien|mani|viso|denti|servizi igienici|wc|bagno|toelett|lav/.test(text)) {
      return `una buona padronanza delle routine di cura di s√© e dell‚Äôigiene personale`;
    }
    // Sociale
    if(/turno|regola|interaz|pari|adulto|aiuto|limite|richiest/.test(text)) {
      return `buone competenze relazionali e di rispetto delle regole sociali di base`;
    }
    // Apprendimenti/attenzione
    if(/attenz|consegna|studio|compito|legge|scrive|calcol|comprend/.test(text)) {
      return `una discreta tenuta nelle competenze di apprendimento, soprattutto in contesti strutturati`;
    }

    // fallback generico
    return `competenze complessivamente adeguate nell‚Äôarea ‚Äú${areaName}‚Äù`;
  }

  function examples(items, maxN){
    const ex = items.slice(0, maxN).map(toInfinitiveItem).filter(Boolean);
    return unique(ex);
  }

  function buildArea(area){
    const strengths = pickLabels(area.key, "strength");
    const priorities = pickLabels(area.key, "priority");

    if(!strengths.length && !priorities.length) return "";

    const lines = [];
    lines.push(`Area ‚Äú${area.name}‚Äù.`);

    // Forza
    if(strengths.length){
      const head = semanticHeadline(area.name, strengths);
      const ex = examples(strengths, 4);

      lines.push(
        `Nel contesto delle attivit√† osservate, il ragazzo ${head}.`
      );

      if(ex.length){
        lines.push(
          `In particolare, nelle situazioni proposte risulta generalmente efficace nel: ${joinNatural(ex)}.`
        );
      } else {
        lines.push(
          `Le prestazioni risultano pi√π stabili quando le consegne sono chiare e l‚Äôattivit√† √® ben strutturata.`
        );
      }
    } else {
      lines.push(
        `In quest‚Äôarea si osserva un funzionamento ancora in consolidamento, con benefici maggiori in presenza di consegne chiare, routine prevedibili e mediazione educativa.`
      );
    }

    // Priorit√†
    if(priorities.length){
      const exP = examples(priorities, 4);
      lines.push(
        `Permangono tuttavia alcuni aspetti da potenziare, soprattutto nelle situazioni meno prevedibili o nelle fasi di avvio e mantenimento del compito.`
      );
      if(exP.length){
        lines.push(
          `In particolare, risulta utile continuare a lavorare su: ${joinNatural(exP)}.`
        );
      }
    } else {
      lines.push(
        `Non emergono criticit√† rilevanti nelle situazioni osservate; √® indicato proseguire favorendo mantenimento e generalizzazione delle competenze.`
      );
    }

    // Strategie (una sola, chiara e professionale)
    lines.push(
      `Nel lavoro educativo risulta utile mantenere una strutturazione chiara (supporti visivi, segmentazione del compito), utilizzare prompting graduato con riduzione progressiva dell‚Äôaiuto (fading) e rinforzo positivo, promuovendo la generalizzazione in contesti e situazioni diversi.`
    );

    return lines.join("\n\n");
  }

  const paras = [];
  paras.push(
    `Nel periodo di osservazione considerato, ${name} ha mostrato una partecipazione generalmente adeguata alle attivit√† proposte, con una buona disponibilit√† alla collaborazione nei contesti strutturati e prevedibili.`
  );
  paras.push(
    `La prestazione risulta maggiormente stabile in presenza di routine e consegne operative chiare; in situazioni meno strutturate pu√≤ emergere una maggiore richiesta di mediazione educativa, soprattutto nelle fasi di avvio e mantenimento del compito.`
  );

  for(const area of CHECKLIST){
    const section = buildArea(area);
    if(section) paras.push(section);
  }

  paras.push(
    `Si ritiene opportuno proseguire con interventi mirati al potenziamento dell‚Äôiniziativa personale e alla generalizzazione delle competenze nei diversi contesti di vita quotidiana, favorendo al contempo una progressiva riduzione dei supporti esterni.`
  );
  paras.push(
    `Nota: la presente sezione discorsiva √® generata automaticamente a partire dai dati inseriti in EduFAD e descrive il funzionamento osservato nel contesto di rilevazione; deve essere integrata con osservazioni qualitative dell‚Äô√©quipe.`
  );

  return paras.join("\n\n");
}


  function norm(label){
    if(!label) return "";
    let s = label.trim();
    if(s.endsWith(".")) s=s.slice(0,-1);
    return s.charAt(0).toLowerCase()+s.slice(1);
  }

  function pick(areaKey, mode){
    const area = CHECKLIST.find(a=>a.key===areaKey);
    if(!area) return [];
    const map = assess.responses[areaKey]||{};
    const res=[];
    for(let i=0;i<area.items.length;i++){
      const r = map[i]||{};
      const s = supportVal(r);
      if(s===null) continue;
      const it = area.items[i];
      const lab = norm(it.label||it||"");
      if(mode==="good" && s>=2) res.push(lab);
      if(mode==="bad" && s<=1) res.push(lab);
    }
    return [...new Set(res)];
  }

  function join(arr){
    if(arr.length===1) return arr[0];
    if(arr.length===2) return arr[0]+" e "+arr[1];
    return arr.slice(0,-1).join(", ")+" e "+arr[arr.length-1];
  }

  const paras=[];

  paras.push(`Nel periodo di osservazione considerato, ${name} ha mostrato una partecipazione generalmente adeguata alle attivit√† proposte, con una buona disponibilit√† alla collaborazione nei contesti strutturati e prevedibili.`);
  paras.push("La prestazione risulta maggiormente stabile in presenza di routine e consegne operative chiare; in situazioni meno strutturate pu√≤ emergere una maggiore richiesta di mediazione educativa.");

  for(const area of CHECKLIST){
    const good = pick(area.key,"good");
    const bad = pick(area.key,"bad");
    if(!good.length && !bad.length) continue;

    paras.push(`Area ‚Äú${area.name}‚Äù.`);

    if(good.length){
      paras.push(`Nel contesto delle attivit√† osservate, il ragazzo dimostra buone competenze in quest‚Äôarea, riuscendo generalmente a ${join(good)}.`);
    } else {
      paras.push("In quest‚Äôarea si osserva un funzionamento ancora in fase di consolidamento, che beneficia della guida dell‚Äôadulto.");
    }

    if(bad.length){
      paras.push(`Permangono tuttavia alcune difficolt√†, in particolare rispetto a ${join(bad)}, che richiedono ancora mediazione educativa.`);
    } else {
      paras.push("Non emergono criticit√† rilevanti nelle situazioni osservate.");
    }

    paras.push("Nel lavoro educativo risulta utile mantenere una strutturazione chiara, utilizzare rinforzi positivi e favorire una progressiva autonomia.");
  }

  paras.push("Si ritiene opportuno proseguire con interventi mirati al potenziamento dell‚Äôiniziativa personale e alla generalizzazione delle competenze nei diversi contesti.");
  paras.push("Nota: la presente sezione discorsiva √® generata automaticamente e deve essere integrata con osservazioni qualitative dell‚Äô√©quipe.");

  return paras.join("\n\n");
}


function buildEducationPlanHTML(assess, profile){
  const p = profile || (assess.profileId ? getProfile(assess.profileId) : null);
  const name = p?.name || "Profilo";
  const dob = p?.dob || "";
  const age = (dob && formatAge(dob)) ? formatAge(dob) : "";
  const dateStr = fmtDate(assess.dateISO);
  const avgAll = computeAssessmentAvgSupport(assess);
  const areaAvg = computeAssessmentAreaAvg(assess);

  const areaBlocks = CHECKLIST.map(a=>{
    const avg = areaAvg[a.key];
    if(avg===null) return "";
    const lists = computeAreaItemLists(assess, a.key);
    const strengths = lists.strength.slice(0,6).map(r=>`<li><b>Item ${r.i}</b> ‚Äî ${escapeHtml(r.label)} (S${r.support})</li>`).join("");
    const weaks = lists.weak.slice(0,6).map(r=>`<li><b>Item ${r.i}</b> ‚Äî ${escapeHtml(r.label)} (S${r.support})</li>`).join("");
    const allItems = lists.all.map(r=>{
      const s = (r.support===null? "-" : "S"+r.support);
      const f = (r.freq===null? "-" : "F"+r.freq);
      const g = (r.gen===null? "-" : "G"+r.gen);
      return `<tr><td>Item ${r.i}</td><td>${escapeHtml(r.label)}</td><td style="text-align:center;">${s}</td><td style="text-align:center;">${f}</td><td style="text-align:center;">${g}</td></tr>`;
    }).join("");

    // Obiettivi/strategie generiche, coerenti con la logica supporto
    const obj = avg>=2.5
      ? "Consolidare e generalizzare le competenze, promuovendo autonomia in contesti meno strutturati."
      : (avg>=1.8
         ? "Incrementare l‚Äôautonomia operativa e la continuit√† esecutiva, riducendo progressivamente i supporti esterni."
         : "Potenziare le abilit√† di base con strutturazione, prompting graduato e progressiva riduzione dell‚Äôaiuto.");

    const strat = avg>=2.5
      ? "Routine e consegne chiare; rinforzo differito; generalizzazione in contesti diversi; autovalutazione guidata."
      : (avg>=1.8
         ? "Segmentazione del compito; supporti visivi; prompting gerarchico; fading; rinforzo positivo."
         : "Task analysis; modellamento; prompting verbale/visivo; fading; gestione del tempo con timer; rinforzi frequenti.");

    return `
      <div class="section">
        <h3>3.${a.name}</h3>
        <p><b>Livello medio (Supporto):</b> ${avg.toFixed(2)} / 3</p>

        <div class="grid2">
          <div>
            <h4>Punti di forza</h4>
            ${strengths ? `<ul>${strengths}</ul>` : `<p class="muted">Nessun item con autonomia consolidata rilevato (S‚â•2).</p>`}
          </div>
          <div>
            <h4>Criticit√†</h4>
            ${weaks ? `<ul>${weaks}</ul>` : `<p class="muted">Nessun item critico rilevato (S‚â§1).</p>`}
          </div>
        </div>

        <h4>Obiettivi educativi</h4>
        <p>${escapeHtml(obj)}</p>

        <h4>Strategie e strumenti</h4>
        <p>${escapeHtml(strat)}</p>

        <h4>Item compilati (dettaglio)</h4>
        <table>
          <thead>
            <tr><th style="width:70px;">N.</th><th>Descrizione item</th><th style="width:60px;">Supp.</th><th style="width:60px;">Freq.</th><th style="width:70px;">Gen.</th></tr>
          </thead>
          <tbody>
            ${allItems || `<tr><td colspan="5" class="muted">Nessun item compilato in questa area.</td></tr>`}
          </tbody>
        </table>
      </div>
    `;
  }).join("");

  const profiloTxt = generateClinicalNarrative(assess, p).replace(/\n/g,"<br>");
  const diaryTxt = buildDiaryNarrative(assess, p).replace(/\n/g,"<br>");

  const idxTxt = (avgAll===null) ? "n.d." : (avgAll.toFixed(2) + " / 3");

  return `
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Piano Educativo - ${escapeHtml(name)} - ${dateStr}</title>
  <style>
    @page { margin: 18mm; }
    body{ font-family: Arial, Helvetica, sans-serif; color:#111; }
    h1{ text-align:center; font-size:18px; margin:0 0 6px; }
    .sub{ text-align:center; color:#444; font-size:12px; margin-bottom:18px; }
    h2{ font-size:14px; margin:18px 0 8px; }
    h3{ font-size:13px; margin:0 0 8px; }
    h4{ font-size:12px; margin:12px 0 6px; }
    p{ font-size:11px; line-height:1.45; margin:6px 0; }
    .muted{ color:#666; }
    .box{ border:1px solid #ddd; border-radius:10px; padding:10px 12px; }
    .row{ display:flex; gap:14px; flex-wrap:wrap; }
    .col{ flex:1; min-width:240px; }
    table{ width:100%; border-collapse:collapse; margin-top:6px; }
    th, td{ border:1px solid #ddd; padding:6px; font-size:10.5px; vertical-align:top; }
    th{ background:#f3f3f3; }
    ul{ margin:6px 0 0 16px; }
    li{ font-size:11px; line-height:1.35; margin:3px 0; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .section{ page-break-inside: avoid; margin-bottom:14px; }
    .sig{ margin-top:22px; }
    .sig div{ margin:10px 0; font-size:11px; }
    .divider{ margin:14px 0; border-top:1px dashed #bbb; }
  </style>
</head>
<body>
  <h1>PIANO EDUCATIVO PERSONALIZZATO</h1>
  <div class="sub">Generato automaticamente da EduFAD</div>

  <h2>1. DATI GENERALI</h2>
  <div class="box">
    <div class="row">
      <div class="col"><p><b>Nome alunno:</b> ${escapeHtml(name)}</p></div>
      <div class="col"><p><b>Data di nascita:</b> ${escapeHtml(dob || "‚Äî")}</p></div>
      <div class="col"><p><b>Et√†:</b> ${escapeHtml(age || "‚Äî")}</p></div>
    </div>
    <div class="row">
      <div class="col"><p><b>Data rilevazione:</b> ${escapeHtml(dateStr)}</p></div>
      <div class="col"><p><b>Operatore referente:</b> ____________________</p></div>
      <div class="col"><p><b>Struttura/Scuola:</b> ____________________</p></div>
    </div>
    <p class="muted"><b>Indice sintetico (Supporto medio complessivo):</b> ${escapeHtml(idxTxt)}</p>
  </div>

  <h2>2. PROFILO DI FUNZIONAMENTO</h2>
  <div class="box"><p>${profiloTxt}</p></div>

  <h2>3. AREE DI FUNZIONAMENTO</h2>
  ${areaBlocks || '<p class="muted">Nessuna area compilata nella rilevazione selezionata.</p>'}

  <h2>4. OBIETTIVI GENERALI</h2>
  <div class="box">
    <ul>
      <li>Potenziare le autonomie nelle aree con maggior criticit√†, con riduzione progressiva dei supporti.</li>
      <li>Consolidare le competenze gi√† emergenti e favorirne la generalizzazione in contesti diversi.</li>
      <li>Incrementare iniziativa personale, continuit√† esecutiva e gestione autonoma delle routine.</li>
      <li>Monitorare l‚Äôandamento attraverso rilevazioni periodiche EduFAD e osservazioni strutturate.</li>
    </ul>
  </div>

  <h2>5. PROGRAMMA DI INTERVENTO</h2>
  <div class="box">
    <table>
      <thead><tr><th>Area</th><th>Obiettivo</th><th>Strumento</th><th>Frequenza</th><th>Verifica</th></tr></thead>
      <tbody>
        ${CHECKLIST.map(a=>{
          const av = areaAvg[a.key];
          if(av===null) return "";
          const ob = av>=2.5 ? "Consolidamento/generalizzazione" : (av>=1.8 ? "Autonomia operativa" : "Competenze di base/avvio e mantenimento");
          const str = av>=2.5 ? "Routine + autovalutazione" : (av>=1.8 ? "Supporti visivi + prompting" : "Task analysis + prompting");
          const freq = "Quotidiana";
          const ver = "Mensile";
          return `<tr><td>${escapeHtml(a.name)}</td><td>${escapeHtml(ob)}</td><td>${escapeHtml(str)}</td><td style="text-align:center;">${freq}</td><td style="text-align:center;">${ver}</td></tr>`;
        }).join("") || `<tr><td colspan="5" class="muted">‚Äî</td></tr>`}
      </tbody>
    </table>
  </div>

  <h2>6. MONITORAGGIO E VERIFICA</h2>
  <div class="box">
    <p>Il monitoraggio avverr√† mediante rilevazioni periodiche EduFAD, osservazioni strutturate e confronto in √©quipe multidisciplinare. Eventuali rimodulazioni del piano saranno effettuate in base all‚Äôandamento del profilo funzionale e agli esiti delle verifiche.</p>
  </div>

  <h2>7. NOTE CONCLUSIVE</h2>
  <div class="box">
    <p>Il presente Piano Educativo √® uno strumento dinamico e suscettibile di revisione periodica. La descrizione √® generata automaticamente sulla base dei punteggi inseriti (Supporto 0‚Äì3; eventuali F e G) e deve essere interpretata nel contesto specifico di osservazione.</p>
  </div>

  <h2>8. DIARIO EDUCATIVO (SEZIONE DISCORSIVA)</h2>
  <div class="box"><p>${diaryTxt}</p></div>

  <div class="divider"></div>

  <h2>FIRME</h2>
  <div class="sig">
    <div>Operatore: ____________________________</div>
    <div>Coordinatore: _________________________</div>
    <div>Data: ________________________________</div>
  </div>
</body>
</html>
  `;
}

function openEducationPlanPrint(assessId){
  const assess = getAssessmentById(assessId);
  if(!assess){ alert("Rilevazione non trovata."); return; }
  const p = getProfile(assess.profileId);
  const html = buildEducationPlanHTML(assess, p);

  const w = window.open("", "_blank");
  if(!w){ alert("Popup bloccato dal browser."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();

  // Avviso: salvataggio come PDF tramite stampa
  setTimeout(()=>{
    try{ w.focus(); w.print(); }catch(e){}
  }, 400);
}
window.openEducationPlanPrint = openEducationPlanPrint;



  }
  const coverPct = total ? Math.round((filled/total)*100) : 0;

  // Compose narrative with controlled, professional tone
  const lines = [];
  lines.push("Valutazione funzionale complessiva");
  lines.push("");
  const name = p?.name ? p.name : "Il ragazzo";
  const ageStr = (p?.dob && formatAge(p.dob)) ? ` (${formatAge(p.dob)})` : "";

  // Opening framing
  if(avgAll===null){
    lines.push(`${name}${ageStr} presenta un profilo di funzionamento non pienamente definibile, in quanto i dati disponibili non consentono il calcolo di un indice sintetico affidabile.`);
  }else if(avgAll>=2.5){
    lines.push(`${name}${ageStr} presenta un profilo di funzionamento complessivamente positivo, con prevalenza di autonomie consolidate e necessit√† di supporto limitate nella maggior parte delle attivit√† osservate.`);
  }else if(avgAll>=1.8){
    lines.push(`${name}${ageStr} presenta un profilo di funzionamento di livello intermedio, con autonomie parziali e necessit√† di supporto variabile in relazione al contesto e alla struttura dell‚Äôattivit√†.`);
  }else{
    lines.push(`${name}${ageStr} presenta un profilo di funzionamento caratterizzato da un bisogno di supporto frequente, con ridotta stabilit√† delle autonomie nelle attivit√† osservate.`);
  }

  // Areas phrasing
  if(strength && priority && strength.name !== priority.name){
    lines.push("");
    lines.push(`Si osserva una maggiore efficacia nell‚Äôarea ‚Äú${strength.name}‚Äù, mentre risultano pi√π critiche le competenze dell‚Äôarea ‚Äú${priority.name}‚Äù.`);
  }

  // Context dependence and prompting inference (non-clinical but professional)
  lines.push("");
  if(avgAll!==null && avgAll>=2.5){
    lines.push("La performance appare pi√π stabile anche in condizioni meno strutturate; si raccomanda comunque il mantenimento di routine e indicazioni chiare per favorire la continuit√† del funzionamento.");
  }else if(avgAll!==null && avgAll>=1.8){
    lines.push("La performance risulta pi√π efficace in contesti guidati e prevedibili; in situazioni meno strutturate pu√≤ emergere una riduzione dell‚Äôiniziativa e della continuit√† operativa, rendendo utile una mediazione educativa graduata.");
  }else if(avgAll!==null){
    lines.push("La performance risulta significativamente dipendente da supervisione e mediazione dell‚Äôadulto; in assenza di strutturazione possono emergere difficolt√† di avvio, mantenimento e completamento delle sequenze operative.");
  }

  // Support type suggestion based on low items count
  lines.push("");
  if(low >= 12){
    lines.push("√à indicato l‚Äôutilizzo sistematico di supporti (prompting verbale/visivo, modellamento e task analysis), con progressiva sfumatura (fading) e monitoraggio della generalizzazione in contesti naturali.");
  }else{
    lines.push("Si suggerisce un impiego mirato di supporti (prompting verbale/visivo) focalizzato sugli item pi√π deboli, con progressiva riduzione dell‚Äôaiuto e consolidamento delle routine.");
  }

  // Data quality note
  lines.push("");
  if(coverPct < 70){
    lines.push("Nota metodologica: la copertura di compilazione √® parziale; si consiglia di completare gli item mancanti per una lettura pi√π rappresentativa del profilo.");
  }else{
    lines.push("Nota metodologica: la lettura √® basata sui punteggi inseriti (Supporto 0‚Äì3) e descrive il funzionamento osservato nel contesto di rilevazione.");
  }

  return lines.join("\n");
}


function ensureAssessmentSummary(assess){
  try{
    if(!assess.summaryText || !assess.summaryText.trim()){
      const p = assess.profileId ? getProfile(assess.profileId) : null;
      assess.summaryText = generateAssessmentSummary(assess, p);
    }
  }catch(e){}
}

function computeAssessmentAvgSupport(assess){
  if(!assess || assess.isDeleted) return null;
  ensureResponseMap(assess);
  let sum=0, n=0;
  for(const area of CHECKLIST){
    const map = assess.responses[area.key];
    for(let i=0;i<area.items.length;i++){
      const v = map[i]?.support;
      if(v===0 || v===1 || v===2 || v===3){
        sum += v; n++;
      }
    }
  }
  return n ? (sum/n) : null;
}

function computeAssessmentAreaAvg(assess){
  ensureResponseMap(assess);
  const out = {};
  for(const area of CHECKLIST){
    let sum=0, n=0;
    const map = assess.responses[area.key];
    for(let i=0;i<area.items.length;i++){
      const v = map[i]?.support;
      if(v===0 || v===1 || v===2 || v===3){ sum+=v; n++; }
    }
    out[area.key] = n ? (sum/n) : null;
  }
  return out;
}

function bindDashboardCanvases(profileId){
  const asAll = getAssessmentsByProfile(profileId).filter(a=>!a.isDeleted).sort((a,b)=> (a.dateISO > b.dateISO ? 1 : -1));
  // trend chart
  const cvTrend = document.getElementById("cvTrend");
  const cvAreas = document.getElementById("cvAreas");
  const cvTrendArea = document.getElementById("cvTrendArea");
  const selTrendArea = document.getElementById("selTrendArea");
  if(!cvTrend || !cvAreas) return;

  // ensure proper pixel ratio
  function setupCanvas(cv){
    const dpr = window.devicePixelRatio || 1;
    const rect = cv.getBoundingClientRect();
    cv.width = Math.max(300, Math.floor(rect.width * dpr));
    cv.height = Math.max(220, Math.floor(rect.height * dpr));
    const ctx = cv.getContext("2d");
    ctx.scale(dpr, dpr);
    return { ctx, w: rect.width, h: rect.height };
  }

  // Draw: Trend line of avg support
  {
    const {ctx, w, h} = setupCanvas(cvTrend);
    drawChartFrame(ctx, w, h, "0", "3");
    const points = asAll.map((a, i)=>({
      x: i,
      y: computeAssessmentAvgSupport(a),
      label: fmtDate(a.dateISO)
    })).filter(p=>p.y!==null);

    drawLineSeries(ctx, w, h, points, 0, 3);
  }


  // Draw: Trend line for selected area
  if(cvTrendArea && selTrendArea){
    function drawSelectedAreaTrend(){
      const areaKey = selTrendArea.value;
      const {ctx, w, h} = setupCanvas(cvTrendArea);
      drawChartFrame(ctx, w, h, "0", "3");
      const points = asAll.map((a, i)=>{
        const avgs = computeAssessmentAreaAvg(a);
        return { x:i, y: avgs ? avgs[areaKey] : null, label: fmtDate(a.dateISO) };
      }).filter(p=>p.y!==null);
      if(points.length===0){
        drawEmpty(ctx, w, h, "Dati non disponibili");
      } else {
        drawLineSeries(ctx, w, h, points, 0, 3);
      }
    }
    selTrendArea.onchange = drawSelectedAreaTrend;

    // redraw on resize to avoid tagli
    let ro;
    try{
      ro = new ResizeObserver(()=> drawSelectedAreaTrend());
      ro.observe(cvTrendArea);
    }catch(e){}
    drawSelectedAreaTrend();
  }

  // Draw: Bar by area (latest)
  {
    const {ctx, w, h} = setupCanvas(cvAreas);
    drawChartFrame(ctx, w, h, "0", "3");
    const latest = asAll.length ? asAll[asAll.length-1] : null;
    if(!latest){
      drawEmpty(ctx, w, h, "Nessuna rilevazione");
    } else {
      const avgs = computeAssessmentAreaAvg(latest);
      const bars = CHECKLIST.map((area, i)=>({
        key: area.key,
        name: area.name,
        v: avgs[area.key]
      }));
      drawBars(ctx, w, h, bars, 0, 3);
    }
  }
}

function drawChartFrame(ctx, w, h, yMinLabel, yMaxLabel){
  ctx.clearRect(0,0,w,h);
  const pad = 28;
  // grid
  ctx.strokeStyle = "rgba(142,160,199,.18)";
  ctx.lineWidth = 1;
  for(let i=0;i<=3;i++){
    const y = pad + (h - pad*2) * (i/3);
    ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-pad, y); ctx.stroke();
  }
  // axes
  ctx.strokeStyle = "rgba(34,48,90,.9)";
  ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke();

  // labels
  ctx.fillStyle = "rgba(142,160,199,.85)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText(yMaxLabel, 6, pad+4);
  ctx.fillText(yMinLabel, 6, h-pad+4);
}

function drawEmpty(ctx, w, h, msg){
  ctx.fillStyle = "rgba(142,160,199,.85)";
  ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(msg, 40, h/2);
}

function mapToChart(w, h, x, xMin, xMax, y, yMin, yMax){
  const pad = 28;
  const cw = w - pad*2;
  const ch = h - pad*2;
  const nx = (xMax===xMin) ? 0 : (x - xMin)/(xMax - xMin);
  const ny = (yMax===yMin) ? 0 : (y - yMin)/(yMax - yMin);
  return {
    px: pad + nx*cw,
    py: pad + (1-ny)*ch
  };
}

function drawLineSeries(ctx, w, h, points, yMin, yMax){
  if(points.length===0){ drawEmpty(ctx,w,h,"Compila almeno un supporto (0‚Äì3)"); return; }
  const xMin = 0, xMax = Math.max(1, points.length-1);

  // line
  ctx.strokeStyle = "rgba(106,169,255,.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  points.forEach((p,i)=>{
    const {px,py} = mapToChart(w,h,i,xMin,xMax,p.y,yMin,yMax);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  });
  ctx.stroke();

  // points
  points.forEach((p,i)=>{
    const {px,py} = mapToChart(w,h,i,xMin,xMax,p.y,yMin,yMax);
    ctx.fillStyle = "rgba(124,255,198,.95)";
    ctx.beginPath(); ctx.arc(px,py,4,0,Math.PI*2); ctx.fill();
    // x labels (sparse)
    if(points.length<=6 || i===0 || i===points.length-1){
      ctx.fillStyle = "rgba(142,160,199,.85)";
      ctx.font = "11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
      ctx.fillText(p.label, Math.max(30, px-28), h-8);
    }
  });
}

function drawBars(ctx, w, h, bars, yMin, yMax){
  const pad = 28;
  const cw = w - pad*2;
  const ch = h - pad*2;

  const n = bars.length;
  const gap = 8;
  const bw = Math.max(14, (cw - gap*(n-1)) / n);

  bars.forEach((b,i)=>{
    const v = (b.v===null || b.v===undefined) ? null : b.v;
    const x = pad + i*(bw+gap);
    const baseY = pad + ch;
    const hBar = v===null ? 0 : ( (v - yMin)/(yMax - yMin) ) * ch;

    ctx.fillStyle = v===null ? "rgba(142,160,199,.15)" : "rgba(106,169,255,.35)";
    ctx.strokeStyle = "rgba(34,48,90,.9)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(x, baseY - hBar, bw, hBar, 8);
    ctx.fill();
    ctx.stroke();

    // value
    ctx.fillStyle = "rgba(231,236,255,.9)";
    ctx.font = "11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    ctx.fillText(v===null ? "‚Äî" : v.toFixed(2), x+2, Math.max(pad+12, baseY - hBar - 6));

    // label (short)
    ctx.fillStyle = "rgba(142,160,199,.85)";
    ctx.font = "10px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const short = b.name.replace("Gestione ","").replace("Autonomie ","");
    ctx.save();
    ctx.translate(x + bw/2, h - 4);
    ctx.rotate(-Math.PI/8);
    ctx.textAlign="center";
    ctx.fillText(short, 0, 0);
    ctx.restore();
  });
}

/* rounded rect support */
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    this.beginPath();
    this.moveTo(x+rr, y);
    this.arcTo(x+w, y, x+w, y+h, rr);
    this.arcTo(x+w, y+h, x, y+h, rr);
    this.arcTo(x, y+h, x, y, rr);
    this.arcTo(x, y, x+w, y, rr);
    this.closePath();
    return this;
  };
}

/* ============================
   10) Export / Demo seed / Reset
   ============================ */
function exportJSON(){
  const pid = selectedProfileId;
  if(!pid) return;
  const p = getProfile(pid);
  const data = {
    exportedAt: nowISO(),
    profile: p,
    assessments: getAssessmentsByProfile(pid)
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `cfa_demo_${p.name.replace(/\s+/g,"_")}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("Export JSON");
}

function seedDemo(){
  // Create sample profiles + a few assessments with semi-random data
  STATE = { version: "demo-v1.1", profiles: [], assessments: [] };

  const p1 = { id: uid(), name: "Profilo Demo ‚Äì Ragazzo A", createdAt: nowISO(), updatedAt: nowISO() };
  const p2 = { id: uid(), name: "Profilo Demo ‚Äì Ragazzo B", createdAt: nowISO(), updatedAt: nowISO() };
  STATE.profiles.push(p1,p2);

  function addAssess(p, dateStr, base){
    const a = { id: uid(), profileId: p.id, dateISO: dateStr+"T00:00:00.000Z", createdAt: nowISO(), updatedAt: nowISO(), responses:{} };
    ensureResponseMap(a);
    // Fill supports around base with noise, plus some nulls
    for(const area of CHECKLIST){
      for(let i=0;i<area.items.length;i++){
        const r = a.responses[area.key][i];
        const coin = Math.random();
        if(coin < 0.10){ r.support=null; } else {
          const v = Math.max(0, Math.min(3, Math.round(base + (Math.random()-.5)*1.2)));
          r.support = v;
        }
        // some freq/gen
        r.freq = (Math.random()<0.4) ? null : FREQ_LEVELS[Math.floor(Math.random()*FREQ_LEVELS.length)];
        r.gen  = (Math.random()<0.4) ? null : GEN_LEVELS[Math.floor(Math.random()*GEN_LEVELS.length)];
        r.context = (Math.random()<0.5) ? null : CONTEXTS[Math.floor(Math.random()*CONTEXTS.length)];
        r.note = (Math.random()<0.85) ? "" : "Nota demo: errore funzionale osservato in contesto specifico.";
      }
    }
    STATE.assessments.push(a);
  }

  // dates
  addAssess(p1, "2025-10-01", 2.2);
  addAssess(p1, "2025-12-01", 1.8);
  addAssess(p1, "2026-01-15", 1.5);

  addAssess(p2, "2025-11-10", 2.6);
  addAssess(p2, "2026-01-10", 2.1);

  saveState(STATE);
  toast("Demo caricata");
  selectedProfileId = p1.id;
  selectedAssessmentId = getAssessmentsByProfile(p1.id).filter(a=>!a.isDeleted)[0]?.id || null;
  activeAreaKey = CHECKLIST[0].key;
  renderProfiles();
  selectProfile(selectedProfileId);
}

function resetAll(){
  const ok = confirm("Reset: cancello tutti i dati demo dal browser. Procedo?");
  if(!ok) return;
  localStorage.removeItem(STORAGE_KEY);
  STATE = { version: "demo-v1.1", profiles: [], assessments: [] };
  selectedProfileId = null;
  selectedAssessmentId = null;
  activeAreaKey = null;
  toast("Dati resettati");
  renderProfiles();
  renderRightPane();
}

/* ============================
   11) Tiny security: escape
   ============================ */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* ============================
   12) Wire buttons & init
   ============================ */
document.getElementById("btnNewProfile").onclick = newProfile;
document.getElementById("btnNewAssessment").onclick = newAssessment;
document.getElementById("btnExportJSON").onclick = exportJSON;
document.getElementById("btnSeed").onclick = seedDemo;
document.getElementById("btnReset").onclick = resetAll;
document.getElementById("profileSearch").addEventListener("input", renderProfiles);

renderProfiles();
renderRightPane();
</script>

<script>
(function(){
  const KEY = "edufad_disclaimer_accepted_v11";
  const overlay = document.getElementById("disclaimerOverlay");
  const accept = document.getElementById("btnAcceptDisclaimer");
  const exit = document.getElementById("btnExitDisclaimer");

  function show(){ if(overlay) overlay.style.display="flex"; }
  function hide(){ if(overlay) overlay.style.display="none"; }

  try{
    const accepted = localStorage.getItem(KEY) === "1";
    if(!accepted) show();
  }catch(e){ show(); }

  accept?.addEventListener("click", () => {
    try{ localStorage.setItem(KEY, "1"); }catch(e){}
    hide();
  });

  exit?.addEventListener("click", () => {
    hide();
    try{ window.open('','_self'); window.close(); }catch(e){}
    setTimeout(()=>{ document.body.innerHTML = "<div style='font-family:system-ui; padding:24px;'>Sessione chiusa.</div>"; }, 50);
  });
})();
</script>


<script>
(function(){
  const USERS_KEY = "edufad_users_v11";
  const SESSION_KEY = "edufad_session_v11";

  function loadUsers(){
    try{
      const raw = localStorage.getItem(USERS_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    const seed = [
      { username:"admin", password:"admin", role:"admin", active:true },
      { username:"editor", password:"editor", role:"editor", active:true }
    ];
    try{ localStorage.setItem(USERS_KEY, JSON.stringify(seed)); }catch(e){}
    return seed;
  }

  function setSession(sess){
    try{ localStorage.setItem(SESSION_KEY, JSON.stringify(sess)); }catch(e){}
  }
  function getSession(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }

  function showLogin(){
    const o = document.getElementById("loginOverlay");
    if(o) o.style.display = "flex";
  }
  function hideLogin(){
    const o = document.getElementById("loginOverlay");
    if(o) o.style.display = "none";
  }

  function setRoleBadge(){
    const sess = getSession();
    // Optional: show role in header if an element exists
    const el = document.getElementById("roleBadge");
    if(el){
      el.textContent = sess?.role ? ("Ruolo: " + sess.role.toUpperCase()) : "";
      el.style.display = sess?.role ? "inline-flex" : "none";
    }
  }

  // Gate: require login BEFORE using app.
  // We show login after disclaimer acceptance (or immediately if already accepted)
  function ensureLoginGate(){
    const sess = getSession();
    if(sess && sess.username && sess.role){
      hideLogin();
      setRoleBadge();
      window.__EDUFAD_ROLE__ = sess.role;
      window.__EDUFAD_USER__ = sess.username;
      return;
    }
    showLogin();
  }

  // Wire login button
  function bindLogin(){
    const btn = document.getElementById("btnLogin");
    const u = document.getElementById("loginUser");
    const p = document.getElementById("loginPass");
    const err = document.getElementById("loginError");

    function fail(){
      if(err) err.style.display = "block";
    }
    function ok(){
      if(err) err.style.display = "none";
    }

    btn?.addEventListener("click", ()=>{
      const username = (u?.value || "").trim();
      const password = (p?.value || "").trim();
      const users = loadUsers();
      const found = users.find(x => x.active !== false && x.username === username && x.password === password);
      if(!found){ fail(); return; }
      ok();
      setSession({ username: found.username, role: found.role, ts: Date.now() });
      hideLogin();
      setRoleBadge();
      window.__EDUFAD_ROLE__ = found.role;
      window.__EDUFAD_USER__ = found.username;

      // Soft refresh UI if app already rendered
      try{ if(typeof window.__renderApp === "function") window.__renderApp(); }catch(e){}
    });

    // Enter key to submit
    [u,p].forEach(inp=>{
      inp?.addEventListener("keydown",(ev)=>{
        if(ev.key==="Enter"){ btn?.click(); }
      });
    });
  }

  // Insert a small role badge in topbar if possible
  function injectRoleBadge(){
    // try find header right area
    const top = document.querySelector(".topbar") || document.querySelector("header") || document.body;
    if(!top) return;
    if(document.getElementById("roleBadge")) return;
    const badge = document.createElement("div");
    badge.id = "roleBadge";
    badge.style.display = "none";
    badge.style.marginLeft = "10px";
    badge.style.padding = "6px 10px";
    badge.style.borderRadius = "999px";
    badge.style.border = "1px solid rgba(255,255,255,.35)";
    badge.style.background = "rgba(255,255,255,.12)";
    badge.style.color = "#fff";
    badge.style.fontSize = "12px";
    badge.style.fontWeight = "700";
    badge.style.alignSelf = "center";
    // append near end
    top.appendChild(badge);
  }

  // Hook into disclaimer acceptance: when disclaimer hides, we enforce login.
  // If disclaimer script already stored acceptance, we enforce on load.
  window.addEventListener("load", ()=>{
    injectRoleBadge();
    bindLogin();
    // Always ensure users exist
    loadUsers();

    // If disclaimer overlay exists and not accepted yet, wait until acceptance then show login.
    const d = document.getElementById("disclaimerOverlay");
    const accept = document.getElementById("btnAcceptDisclaimer");
    if(d && d.style.display !== "none"){
      accept?.addEventListener("click", ()=> setTimeout(ensureLoginGate, 50));
      // also show login after acceptance later
    } else {
      ensureLoginGate();
    }
  });

  // Expose a simple logout (can be used later in UI)
  window.__logout = function(){
    try{ localStorage.removeItem(SESSION_KEY); }catch(e){}
    showLogin();
    setRoleBadge();
    window.__EDUFAD_ROLE__ = null;
    window.__EDUFAD_USER__ = null;
  };
})();
</script>


<script>
(function(){
  function showLogout(){
    const b = document.getElementById("btnLogout");
    if(b) b.style.display = "inline-flex";
  }
  function hideLogout(){
    const b = document.getElementById("btnLogout");
    if(b) b.style.display = "none";
  }

  function bindLogout(){
    const b = document.getElementById("btnLogout");
    if(!b) return;
    b.addEventListener("click", ()=>{
      if(window.__logout) window.__logout();
      hideLogout();
      try{ location.reload(); }catch(e){}
    });
  }

  // Hook into login lifecycle
  const oldEnsure = window.__EDUFAD_ROLE__;

  window.addEventListener("load", ()=>{
    bindLogout();
    // poll session to toggle button
    setInterval(()=>{
      try{
        const sess = JSON.parse(localStorage.getItem("edufad_session_v11")||"null");
        if(sess && sess.username){ showLogout(); }
        else { hideLogout(); }
      }catch(e){ hideLogout(); }
    }, 800);
  });
})();
</script>

<script>
(function(){
  const SESSION_KEY = "edufad_session_v11";

  function getSession(){
    try{ return JSON.parse(localStorage.getItem(SESSION_KEY) || "null"); }catch(e){ return null; }
  }

  function ensureUsersButton(){
    if(document.getElementById("btnUsers")) return;

    const btn = document.createElement("button");
    btn.id = "btnUsers";
    btn.textContent = "Utenti";
    btn.style.marginLeft = "10px";
    btn.style.padding = "6px 12px";
    btn.style.borderRadius = "999px";
    btn.style.border = "1px solid rgba(255,255,255,.45)";
    btn.style.background = "rgba(255,255,255,.15)";
    btn.style.color = "#fff";
    btn.style.fontSize = "12px";
    btn.style.fontWeight = "800";
    btn.style.cursor = "pointer";
    btn.style.display = "none";

    // Place near Logout if present, else in header/topbar, else body
    const logout = document.getElementById("btnLogout");
    if(logout && logout.parentElement){
      logout.parentElement.insertBefore(btn, logout);
    } else {
      const top = document.querySelector(".topbar") || document.querySelector("header") || document.body;
      top.appendChild(btn);
    }

    // Bind open users modal
    btn.addEventListener("click", ()=>{
      const o = document.getElementById("usersOverlay");
      if(o){
        o.style.display = "flex";
        // render table if function exists
        try{ if(typeof window.__renderUsersTable === "function") window.__renderUsersTable(); }catch(e){}
      }
    });
  }

  function roleGate(){
    ensureUsersButton();
    const sess = getSession();
    const btn = document.getElementById("btnUsers");
    if(!btn) return;
    btn.style.display = (sess && sess.role === "admin") ? "inline-flex" : "none";
  }

  window.addEventListener("load", ()=>{
    // Run immediately and keep in sync
    roleGate();

    // Fast sync for the first few seconds (after login), then slow
    let n = 0;
    const fast = setInterval(()=>{
      roleGate();
      n++;
      if(n>25){ clearInterval(fast); }
    }, 200);

    setInterval(roleGate, 1000);
  });
})();
</script>


<script>
(function(){
  window.addEventListener("load", ()=>{
    const c = document.getElementById("btnCloseUsers");
    c?.addEventListener("click", ()=>{
      const o = document.getElementById("usersOverlay");
      if(o) o.style.display = "none";
    });
  });
})();
</script>


<script>
(function(){
  const USERS_KEY = "edufad_users_v11";
  const SESSION_KEY = "edufad_session_v11";

  function getSession(){
    try{ return JSON.parse(localStorage.getItem(SESSION_KEY) || "null"); }catch(e){ return null; }
  }
  function loadUsers(){
    try{
      const raw = localStorage.getItem(USERS_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return [];
  }
  function saveUsers(users){
    try{ localStorage.setItem(USERS_KEY, JSON.stringify(users)); }catch(e){}
  }
  function esc(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function openUsers(){

  // Mostra backup solo per Admin
  try{
    const sess = getSession();
    const show = !!(sess && sess.role==="admin");
    const dl = document.getElementById("btnBackupDownload");
    const rs = document.getElementById("btnBackupRestore");
    if(dl) dl.style.display = show ? "" : "none";
    if(rs) rs.style.display = show ? "" : "none";
  }catch(e){}

    const sess = getSession();
    if(!sess || sess.role!=="admin") return;
    const o = document.getElementById("usersOverlay");
    if(o) o.style.display = "flex";
    renderUsers();
  }
  function closeUsers(){
    const o = document.getElementById("usersOverlay");
    if(o) o.style.display = "none";
  }

  function renderUsers(){
    const tb = document.getElementById("usersTable");
    if(!tb) return;
    const users = loadUsers();
    tb.innerHTML = users.map(u=>{
      const status = (u.active === false) ? "Disattivo" : "Attivo";
      const btnLabel = (u.active === false) ? "Attiva" : "Disattiva";
      const lock = (u.username === "admin") ? "disabled" : "";
      return `
        <tr>
          <td style="padding:10px 12px; border-top:1px solid var(--line); font-family:var(--mono);">${esc(u.username)}</td>
          <td style="padding:10px 12px; border-top:1px solid var(--line);">${esc((u.role||"").toUpperCase())}</td>
          <td style="padding:10px 12px; border-top:1px solid var(--line);">${status}</td>
          <td style="padding:10px 12px; border-top:1px solid var(--line); text-align:right;">
            <button class="btn ghost" data-act="toggle" data-u="${esc(u.username)}" ${lock} style="margin-right:8px;">${btnLabel}</button>
            <button class="btn ghost" data-act="reset" data-u="${esc(u.username)}" ${lock}>Reset PW</button>
          </td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const act = btn.getAttribute("data-act");
        const uname = btn.getAttribute("data-u");
        const users = loadUsers();
        const u = users.find(x=>x.username===uname);
        if(!u) return;
        if(act==="toggle"){
          u.active = (u.active === false) ? true : false;
          saveUsers(users);
          renderUsers();
          showMsg("Stato utente aggiornato.");
        }
        if(act==="reset"){
          const np = prompt("Nuova password per " + uname + " (min 4 caratteri):");
          if(!np) return;
          if(np.trim().length < 4){ alert("Password troppo corta."); return; }
          u.password = np.trim();
          saveUsers(users);
          renderUsers();
          showMsg("Password aggiornata.");
        }
      });
    });
  }

  function showMsg(text){
    const m = document.getElementById("usersMsg");
    if(!m) return;
    m.textContent = text;
    m.style.display = "block";
    clearTimeout(showMsg._t);
    showMsg._t = setTimeout(()=>{ m.style.display="none"; }, 2200);
  }

  function bind(){
    // Bind Users button (may be injected later)
    function bindUsersBtn(){
      const b = document.getElementById("btnUsers");
      if(!b || b.dataset.bound==="1") return;
      b.dataset.bound = "1";
      b.addEventListener("click", openUsers);
    }

    const close = document.getElementById("btnCloseUsers");
    close?.addEventListener("click", closeUsers);

    const create = document.getElementById("btnCreateEditor");
    create?.addEventListener("click", ()=>{
      const uEl = document.getElementById("newUser");
      const pEl = document.getElementById("newPass");
      const username = (uEl?.value||"").trim();
      const password = (pEl?.value||"").trim();
      if(username.length < 3){ alert("Username troppo corto (min 3)."); return; }
      if(password.length < 4){ alert("Password troppo corta (min 4)."); return; }
      const users = loadUsers();
      if(users.some(x=>x.username===username)){ alert("Username gi√† esistente."); return; }
      users.push({ username, password, role:"editor", active:true });
      saveUsers(users);
      if(uEl) uEl.value="";
      if(pEl) pEl.value="";
      renderUsers();
      showMsg("Editor creato.");
    });


    const bkpDl = document.getElementById("btnBackupDownload");
    bkpDl?.addEventListener("click", ()=> downloadBackupEduFAD());

    const bkpRs = document.getElementById("btnBackupRestore");
    const fileIn = document.getElementById("fileBackup");
    bkpRs?.addEventListener("click", ()=>{
      const sess = getSession();
      if(!sess || sess.role!=="admin"){ alert("Solo Admin."); return; }
      fileIn?.click();
    });
    fileIn?.addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      // reset input so same file can be chosen again later
      e.target.value = "";
      restoreBackupEduFAD(f);
    });


    // Keep trying to bind btnUsers if injected later
    bindUsersBtn();
    setInterval(bindUsersBtn, 300);
  }

  window.addEventListener("load", ()=>{
    // Ensure seed users exist (admin/editor) if missing
    const users = loadUsers();
    if(!users || users.length===0){
      saveUsers([
        { username:"admin", password:"admin", role:"admin", active:true },
        { username:"editor", password:"editor", role:"editor", active:true }
      ]);
    }
    bind();
  });

  // Expose for other scripts
  window.__openUsers = openUsers;
  window.__renderUsersTable = renderUsers;
})();
</script>


<script>
(function(){
  const SESSION_KEY="edufad_session_v11";
  function getSession(){ try{return JSON.parse(localStorage.getItem(SESSION_KEY)||"null");}catch(e){return null;} }

  function ensurePermNote(){
    if(document.getElementById("permNote")) return;
    const sess = getSession();
    if(!sess || !sess.username) return;

    const host = document.querySelector(".topbar") || document.querySelector("header") || null;
    if(!host) return;

    const note = document.createElement("div");
    note.id="permNote";
    note.style.marginLeft="10px";
    note.style.padding="6px 10px";
    note.style.borderRadius="999px";
    note.style.border="1px solid rgba(255,255,255,.25)";
    note.style.background="rgba(255,255,255,.10)";
    note.style.color="#fff";
    note.style.fontSize="12px";
    note.style.fontWeight="600";
    note.style.alignSelf="center";

    if(sess.role==="admin"){
      note.textContent="Permessi: completi (Admin)";
    } else {
      note.textContent="Permessi: completi (Editor) ‚Äì gestione utenti solo Admin";
    }
    host.appendChild(note);
  }

  window.addEventListener("load", ()=>{
    ensurePermNote();
    // update after login as well
    setInterval(ensurePermNote, 800);
  });
})();
</script>


<script>
(function(){
  window.addEventListener("load", ()=>{
    const b = document.getElementById("btnResetLocal");
    b?.addEventListener("click", ()=>{
      const ok = confirm("Vuoi cancellare utenti/sessioni/dati salvati in questo browser per EduFAD?");
      if(!ok) return;
      try{
        ["edufad_session_v11","edufad_users_v11","edufad_disclaimer_accepted_v11"].forEach(k=>localStorage.removeItem(k));
      }catch(e){}
      try{ location.reload(); }catch(e){}
    });
  });
})();
</script>


<script>
(function(){
  const SESSION_KEY="edufad_session_v11";
  function getSession(){ try{return JSON.parse(localStorage.getItem(SESSION_KEY)||"null");}catch(e){return null;} }

  function injectUserBadge(){
    if(document.getElementById("userBadge")) return;
    const top = document.querySelector(".topbar") || document.querySelector("header") || document.body;
    if(!top) return;
    const badge = document.createElement("div");
    badge.id = "userBadge";
    badge.textContent = "";
    top.appendChild(badge);
  }

  function updateUserBadge(){
    const badge = document.getElementById("userBadge");
    if(!badge) return;
    const sess = getSession();
    if(sess && sess.username){
      badge.textContent = "Utente: " + String(sess.username);
      badge.style.display = "inline-flex";
    }else{
      badge.textContent = "";
      badge.style.display = "none";
    }
  }

  window.addEventListener("load", ()=>{
    injectUserBadge();
    updateUserBadge();
    // Aggiorna dopo login e al refresh UI
    setInterval(updateUserBadge, 600);
  });
})();
</script>


<script>
(function(){
  function renderAreaEditorTable(assess, areaKey){
    ensureResponseMap(assess);
    const area = CHECKLIST.find(a=>a.key===areaKey) || CHECKLIST[0];

    const rows = area.items.map((label, idx)=>{
      const r = assess.responses[area.key][idx];
      return `
        <tr>
          <td style="width:34%">
            <div style="font-size:13px">${escapeHtml(label)}</div>
            <div class="small muted">Item ${idx+1}</div>
          </td>
          <td style="width:17%">
            ${renderRadioGroup(`s-${area.key}-${idx}`, SUPPORT_LEVELS, r.support)}
            <div class="small muted" style="margin-top:6px">Supporto</div>
          </td>
          <td style="width:17%">
            ${renderRadioGroup(`f-${area.key}-${idx}`, FREQ_LEVELS, r.freq)}
            <div class="small muted" style="margin-top:6px">Frequenza</div>
          </td>
          <td style="width:17%">
            ${renderRadioGroup(`g-${area.key}-${idx}`, GEN_LEVELS, r.gen)}
            <div class="small muted" style="margin-top:6px">Generalizzazione</div>
          </td>
          <td style="width:15%">
            <select data-ctx="${area.key}:${idx}">
              <option value="">‚Äî</option>
              ${CONTEXTS.map(c=>`<option value="${c}" ${r.context===c?"selected":""}>${c}</option>`).join("")}
            </select>
            <div class="small muted" style="margin-top:6px">Contesto</div>
            <textarea data-note="${area.key}:${idx}" placeholder="Note (errori funzionali, sicurezza, dettagli)">${escapeHtml(r.note||"")}</textarea>
          </td>
        </tr>
      `;
    }).join("");

    return `
      <div class="row tight" style="justify-content:flex-end">
        <button class="primary" id="btnSaveAssessment">Salva</button>
      </div>
      <div class="sep"></div>
      <table class="table">
        <thead>
          <tr>
            <th>Comportamento (azione completa)</th>
            <th>0‚Äì3</th>
            <th>F0‚ÄìF4</th>
            <th>G0‚ÄìG3</th>
            <th>Contesto & note</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="sep"></div>
      <div class="hint">
        <b>Promemoria v1.1:</b> il numero 0‚Äì3 misura <b>solo il supporto</b>. Frequenza e generalizzazione sono campi separati.
        Gli errori si descrivono in note solo se <b>funzionalmente impattanti</b> o di sicurezza.
      </div>
    `;
  }

  function openAreaModal(areaKey){
    const modal = document.getElementById("areaModal");
    const body = document.getElementById("areaModalBody");
    const title = document.getElementById("areaModalTitle");

    const prof = getProfile(selectedProfileId);
    const assess = selectedAssessmentId ? getAssessment(selectedAssessmentId) : null;
    const area = CHECKLIST.find(a=>a.key===areaKey) || CHECKLIST[0];

    if(!modal || !body || !title || !prof || !assess) return;

    // Title must show profile name + area
    title.textContent = `${prof.name} ‚Äî ${area.name}`;

    body.innerHTML = renderAreaEditorTable(assess, areaKey);
    modal.style.display = "flex";

    // Bind events inside modal (radio/select/textarea + save)
    bindEditorEvents(assess.id);
  }

  function closeAreaModal(){
    const modal = document.getElementById("areaModal");
    if(modal) modal.style.display = "none";
  }

  window.__openAreaModal = openAreaModal;
  window.__closeAreaModal = closeAreaModal;

  window.addEventListener("load", ()=>{
    document.getElementById("btnCloseAreaModal")?.addEventListener("click", closeAreaModal);
    // Close on ESC
    document.addEventListener("keydown", (e)=>{
      if(e.key==="Escape") closeAreaModal();
    });
    // Click outside dialog closes
    const modal = document.getElementById("areaModal");
    modal?.addEventListener("click", (e)=>{
      if(e.target === modal) closeAreaModal();
    });
  });
})();
</script>


<script>
(function(){
  // Intercetta il pulsante Salva e chiede conferma
  function bindConfirmSave(){
    const btn = document.getElementById("btnSaveAssessment");
    if(!btn || btn.dataset.confirmBound==="1") return;

    btn.dataset.confirmBound = "1";

    const oldHandler = btn.onclick;
    btn.onclick = function(e){
      e.preventDefault();

      const ok = confirm("Confermi il salvataggio della rilevazione?");
      if(!ok) return false;

      // Se esiste un handler precedente, eseguilo
      if(typeof oldHandler === "function"){
        oldHandler.call(btn, e);
      }

      // Trigger normale (per i listener gi√† registrati)
      try{
        btn.dispatchEvent(new Event("confirmedSave"));
      }catch(err){}
    };
  }

  // Riaggancia dopo apertura popup
  function watchPopup(){
    const modal = document.getElementById("areaModal");
    if(!modal) return;

    const obs = new MutationObserver(()=>{
      bindConfirmSave();
    });

    obs.observe(modal, { childList:true, subtree:true });
  }

  window.addEventListener("load", ()=>{
    watchPopup();
    setInterval(bindConfirmSave, 400);
  });
})();
</script>


<script>
(function(){
  function showToast(msg){
    const t = document.getElementById("toast");
    if(!t) return;
    t.textContent = msg || "Salvataggio completato correttamente.";
    t.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{ t.style.display = "none"; }, 2200);
  }
  window.__toast = showToast;

  // Hook: after confirmed save, show toast. We listen for clicks on btnSaveAssessment after confirm dialog.
  function bindToastOnSave(){
    const btn = document.getElementById("btnSaveAssessment");
    if(!btn || btn.dataset.toastBound==="1") return;
    btn.dataset.toastBound = "1";

    // If the confirm wrapper dispatches confirmedSave, handle it
    btn.addEventListener("confirmedSave", ()=>{
      showToast("Salvataggio completato correttamente.");
    });

    // Also, as fallback, after click that proceeds, show toast with slight delay
    btn.addEventListener("click", ()=>{
      setTimeout(()=>{
        // only show if modal still open (means user was working) - but ok either way
        showToast("Salvataggio completato correttamente.");
      }, 50);
    }, {capture:false});
  }

  window.addEventListener("load", ()=>{
    setInterval(bindToastOnSave, 300);
  });
})();
</script>


<script>
(function(){
  function closeAreaModalSafe(){
    const m = document.getElementById("areaModal");
    if(m) m.style.display = "none";
  }

  function bindCloseAfterSave(){
    const btn = document.getElementById("btnSaveAssessment");
    if(!btn || btn.dataset.closeBound==="1") return;
    btn.dataset.closeBound = "1";

    // After confirmed save event
    btn.addEventListener("confirmedSave", ()=>{
      setTimeout(closeAreaModalSafe, 80);
    });

    // Fallback: after click (if save proceeds)
    btn.addEventListener("click", ()=>{
      setTimeout(()=>{
        closeAreaModalSafe();
      }, 120);
    });
  }

  window.addEventListener("load", ()=>{
    setInterval(bindCloseAfterSave, 300);
  });
})();
</script>


<script>
(function(){
  const SESSION_KEY="edufad_session_v11";

  function getSession(){
    try{ return JSON.parse(localStorage.getItem(SESSION_KEY)||"null"); }catch(e){ return null; }
  }
  function jclone(x){ return JSON.parse(JSON.stringify(x)); }

  function ensureHistory(assess){
    if(!assess.history) assess.history = [];
  }

  function diffArea(areaKey, beforeArr, afterArr){
    const fields = [
      ["support","Supporto"],
      ["freq","Frequenza"],
      ["gen","Generalizzazione"],
      ["context","Contesto"],
      ["note","Note"]
    ];
    const changes = [];
    const n = Math.max(beforeArr?.length||0, afterArr?.length||0);
    for(let i=0;i<n;i++){
      const b = beforeArr?.[i] || {};
      const a = afterArr?.[i] || {};
      for(const [k,label] of fields){
        const bv = (b[k] ?? "");
        const av = (a[k] ?? "");
        if(String(bv) !== String(av)){
          changes.push({ itemIndex:i+1, itemLabel: (area && area.items && area.items[i]) ? area.items[i] : "", field:label, from:bv, to:av });
        }
      }
    }
    return changes;
  }

  
function renderHistoryHTML(profileName, assess){
  ensureHistory(assess);
  const history = (assess.history||[]).slice().sort((a,b)=>a.ts-b.ts);
  if(history.length===0){
    return '<div class="small muted">Nessuna modifica registrata.</div>';
  }

  function areaNameOf(k){
    return (CHECKLIST.find(a=>a.key===k)?.name) || k || "‚Äî";
  }

  function prevTsFor(currTs, areaKey, itemIndex, field){
    // cerca l'ultima modifica precedente per stesso item/campo
    let prev = null;
    for(const h of history){
      if(h.ts >= currTs) break;
      for(const c of (h.changes||[])){
        if(c.areaKey){} // noop (compat)
        if(h.areaKey===areaKey && c.itemIndex===itemIndex && c.field===field){
          prev = h.ts;
        }
      }
    }
    return prev;
  }

  function fieldKeyFromLabel(label){
    const s = String(label||"").toLowerCase();
    if(s.includes("supporto")) return "support";
    if(s.includes("frequenza")) return "freq";
    if(s.includes("generalizzazione")) return "gen";
    return null;
  }

  // render in reverse (latest first) for readability
  const entries = history.slice().reverse();

  return entries.map(h=>{
    const when = new Date(h.ts).toLocaleString();
    const who = h.user || "‚Äî";
    const role = (h.role||"").toUpperCase();
    const areaName = areaNameOf(h.areaKey);

    const changeBlocks = (h.changes||[]).map((c, idx)=>{
      if(!c.itemLabel){ try{ const area = CHECKLIST.find(a=>a.key===h.areaKey); const i=(c.itemIndex||0)-1; c.itemLabel = (area && area.items && area.items[i]) ? area.items[i] : ""; }catch(e){} }

      const prevTs = prevTsFor(h.ts, h.areaKey, c.itemIndex, c.field);
      const beforeDate = prevTs ? new Date(prevTs).toLocaleString() : "inizio";
      const afterDate = new Date(h.ts).toLocaleString();

      const fk = fieldKeyFromLabel(c.field);
      const canChart = !!fk;

      const chartHTML = canChart ? `
        <div style="margin-top:8px;">
          <canvas class="histTrend"
            data-area="${escapeHtml(h.areaKey)}"
            data-item="${c.itemIndex}"
            data-field="${escapeHtml(fk)}"
            style="width:100%; height:160px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.85);"></canvas>
          <div class="small muted" style="margin-top:6px;">
            Prima: <b>${escapeHtml(beforeDate)}</b> (${escapeHtml(String((c.from ?? "‚Äî")))}) ‚Ä¢
            Dopo: <b>${escapeHtml(afterDate)}</b> (${escapeHtml(String((c.to ?? "‚Äî")))})
          </div>
        </div>
      ` : `
        <div class="small muted" style="margin-top:6px;">
          Prima: <b>${escapeHtml(beforeDate)}</b> (${escapeHtml(String((c.from ?? "‚Äî")))}) ‚Ä¢
          Dopo: <b>${escapeHtml(afterDate)}</b> (${escapeHtml(String((c.to ?? "‚Äî")))})
        </div>
      `;

      return `
        <div style="padding:10px 12px; border-top:1px solid var(--line);">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span class="badge mono">Item ${c.itemIndex} ‚Äî ${escapeHtml(String(c.itemLabel||""))}</span>
            <span style="font-weight:900;">${escapeHtml(c.field)}</span>
            <span class="mono">${escapeHtml(String((c.from ?? "‚Äî")))}</span>
            <span style="opacity:.7;">‚Üí</span>
            <span class="mono">${escapeHtml(String((c.to ?? "‚Äî")))}</span>
          </div>
          ${chartHTML}
        </div>
      `;
    }).join("") || `<div style="padding:10px 12px; color:var(--muted);">Nessuna modifica.</div>`;

    return `
      <div style="margin-bottom:16px; border:1px solid var(--line); border-radius:12px; overflow:hidden;">
        <div style="background:rgba(0,0,0,.05); padding:8px 12px; font-size:13px;">
          <b>${escapeHtml(when)}</b> ‚Äî ${escapeHtml(who)} (${escapeHtml(role)}) ‚Äî ${escapeHtml(areaName)}
        </div>
        ${changeBlocks}
      </div>
    `;
  }).join("");
}


function bindHistoryTrendCharts(assess){
  const container = document.getElementById("historyModalBody");
  if(!container || !assess) return;

  const history = (assess.history||[]).slice().sort((a,b)=>a.ts-b.ts);

  function fieldLabelToKey(label){
    const s = String(label||"").toLowerCase();
    if(s.includes("supporto")) return "support";
    if(s.includes("frequenza")) return "freq";
    if(s.includes("generalizzazione")) return "gen";
    return null;
  }

  function parseVal(fieldKey, v){
    if(v===null || v===undefined || v==="") return null;
    if(fieldKey==="support" || fieldKey==="gen"){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    if(fieldKey==="freq"){
      if(typeof v==="string" && v.toUpperCase().startsWith("F")){
        const n = Number(v.slice(1));
        return Number.isFinite(n) ? n : null;
      }
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    return null;
  }

  function yRange(fieldKey){
    if(fieldKey==="freq") return [0,4];
    return [0,3];
  }

  function fmt(ts){
    try{ return new Date(ts).toLocaleDateString() + " " + new Date(ts).toLocaleTimeString().slice(0,5); }
    catch(e){ return String(ts); }
  }

  function setupCanvas(cv){
    const dpr = window.devicePixelRatio || 1;
    const rect = cv.getBoundingClientRect();
    cv.width = Math.max(320, Math.floor(rect.width * dpr));
    cv.height = Math.max(180, Math.floor(rect.height * dpr));
    const ctx = cv.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return { ctx, w: rect.width, h: rect.height };
  }

  container.querySelectorAll("canvas.histTrend").forEach((cv)=>{
    const areaKey = cv.dataset.area;
    const itemIndex = Number(cv.dataset.item||"0");
    const fieldKey = cv.dataset.field;

    const rel = [];
    for(const h of history){
      if(h.areaKey !== areaKey) continue;
      for(const c of (h.changes||[])){
        const fk = fieldLabelToKey(c.field);
        if(fk !== fieldKey) continue;
        if(Number(c.itemIndex) !== itemIndex) continue;
        rel.push({ ts:h.ts, from:c.from, to:c.to });
      }
    }

    const {ctx, w, h} = setupCanvas(cv);
    const [yMin,yMax] = yRange(fieldKey);
    drawChartFrame(ctx, w, h, String(yMin), String(yMax));

    if(rel.length===0){
      drawEmpty(ctx, w, h, "Nessun dato trend");
      return;
    }

    const points = [];
    const first = rel[0];
    const y0 = parseVal(fieldKey, first.from);
    const y1 = parseVal(fieldKey, first.to);

    if(y0!==null) points.push({ x:0, y:y0, label: fmt(first.ts) + " (prima)" });
    if(y1!==null) points.push({ x:1, y:y1, label: fmt(first.ts) + " (dopo)" });

    for(let i=1;i<rel.length;i++){
      const yi = parseVal(fieldKey, rel[i].to);
      if(yi===null) continue;
      points.push({ x:i+1, y:yi, label: fmt(rel[i].ts) });
    }

    if(points.length===0){
      drawEmpty(ctx, w, h, "Dati non disponibili");
      return;
    }
    drawLineSeries(ctx, w, h, points, yMin, yMax);
  });
}



  // Baseline per area corrente
  let baseline = { areaKey:null, snap:null, profileId:null, assessId:null };

  function setBaseline(profileId, assessId, areaKey){
    try{
      const assess = getAssessment(assessId);
      baseline = {
        profileId, assessId, areaKey,
        snap: jclone(assess.responses?.[areaKey] || [])
      };
    }catch(e){
      baseline = { areaKey, snap:null, profileId, assessId };
    }
  }

  // Hook: when area modal opens, store ids and baseline
  const oldOpen = window.__openAreaModal;
  window.__openAreaModal = function(areaKey){
    if(typeof oldOpen === "function") oldOpen(areaKey);
    try{
      const m = document.getElementById("areaModal");
      if(m){
        m.dataset.profileId = String(selectedProfileId||"");
        m.dataset.assessId = String(selectedAssessmentId||"");
        m.dataset.areaKey = String(areaKey||"");
      }
      if(selectedProfileId && selectedAssessmentId){
        setBaseline(selectedProfileId, selectedAssessmentId, areaKey);
      }
    }catch(e){}
  };

  // Open/close history modal
  function openHistory(){
    const hm = document.getElementById("historyModal");
    const body = document.getElementById("historyModalBody");
    const title = document.getElementById("historyModalTitle");
    const areaModal = document.getElementById("areaModal");

    const profileId = areaModal?.dataset.profileId || String(selectedProfileId||"");
    const assessId  = areaModal?.dataset.assessId  || String(selectedAssessmentId||"");

    if(!hm || !body || !title || !profileId || !assessId) return;

    const prof = getProfile(profileId);
    const assess = getAssessment(assessId);
    if(!prof || !assess) return;

    // close area popup for privacy/clean UI
    if(areaModal) areaModal.style.display = "none";

    title.textContent = prof.name + " ‚Äî Storico modifiche";
    body.innerHTML = renderHistoryHTML(prof.name, assess);
    hm.style.display = "flex";
    try{ bindHistoryTrendCharts(assess); }catch(e){};
  }

  function closeHistory(){
    const hm = document.getElementById("historyModal");
    if(hm) hm.style.display = "none";
  }

  // Bind history buttons
  window.addEventListener("load", ()=>{
    document.getElementById("btnOpenHistory")?.addEventListener("click", openHistory);
    document.getElementById("btnCloseHistoryModal")?.addEventListener("click", closeHistory);

    const hm = document.getElementById("historyModal");
    hm?.addEventListener("click", (e)=>{ if(e.target===hm) closeHistory(); });

    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeHistory(); });
  });

  // Track changes on confirmed save (after save handlers ran)
  function bindHistoryOnSave(){
    const btn = document.getElementById("btnSaveAssessment");
    if(!btn || btn.dataset.histBound==="1") return;
    btn.dataset.histBound = "1";

    btn.addEventListener("confirmedSave", ()=>{
      setTimeout(()=>{
        try{
          const areaModal = document.getElementById("areaModal");
          const profileId = areaModal?.dataset.profileId || String(selectedProfileId||"");
          const assessId  = areaModal?.dataset.assessId  || String(selectedAssessmentId||"");
          const areaKey   = areaModal?.dataset.areaKey   || String(activeAreaKey||CHECKLIST[0]?.key);

          if(!assessId || !areaKey) return;

          const assess = getAssessment(assessId);
          if(!assess) return;
          ensureHistory(assess);

          const sess = getSession() || {};
          const user = sess.username || window.__EDUFAD_USER__ || "‚Äî";
          const role = sess.role || window.__EDUFAD_ROLE__ || "‚Äî";

          const before = (baseline.assessId==assessId && baseline.areaKey==areaKey && baseline.snap) ? baseline.snap : [];
          const after  = jclone(assess.responses?.[areaKey] || []);
          const changes = diffArea(areaKey, before, after);

          assess.history.push({ ts: Date.now(), user, role, areaKey, changes });

          // persist
          saveAssessment(assess);

          // refresh baseline
          setBaseline(profileId, assessId, areaKey);
        }catch(e){}
      }, 220);
    });
  }

  window.addEventListener("load", ()=>{ setInterval(bindHistoryOnSave, 300); });

})();
</script>


<script>
(function(){
  // Baseline snapshots per assessment+area
  window.__H_BASELINE = window.__H_BASELINE || {};

  function sess(){
    try{ return JSON.parse(localStorage.getItem("edufad_session_v11")||"null") || {}; }catch(e){ return {}; }
  }
  function jclone(x){ return JSON.parse(JSON.stringify(x)); }

  function getAreaByKey(k){ return CHECKLIST.find(a=>a.key===k) || CHECKLIST[0]; }

  function setBaselineFor(assessId, areaKey, responsesObj){
    const key = assessId + "::" + areaKey;
    window.__H_BASELINE[key] = jclone(responsesObj || {});
  }
  window.__setBaselineFor = setBaselineFor;

  function getBaselineFor(assessId, areaKey){
    const key = assessId + "::" + areaKey;
    return window.__H_BASELINE[key] || null;
  }

  function diffAreaObj(areaKey, beforeObj, afterObj){
    const area = getAreaByKey(areaKey);
    const fields = [
      ["support","Supporto"],
      ["freq","Frequenza"],
      ["gen","Generalizzazione"],
      ["context","Contesto"],
      ["note","Note"]
    ];
    const changes = [];
    for(let i=0;i<area.items.length;i++){
      const b = (beforeObj && beforeObj[i]) ? beforeObj[i] : {};
      const a = (afterObj && afterObj[i]) ? afterObj[i] : {};
      for(const [k,label] of fields){
        const bv = (b[k] ?? "");
        const av = (a[k] ?? "");
        if(String(bv) !== String(av)){
          changes.push({ itemIndex:i+1, itemLabel: (area && area.items && area.items[i]) ? area.items[i] : "", field:label, from:bv, to:av });
        }
      }
    }
    return changes;
  }
  window.__diffAreaObj = diffAreaObj;

  // Ensure baseline gets set whenever area popup opens
  const oldOpen = window.__openAreaModal;
  window.__openAreaModal = function(areaKey){
    try{
      const assess = selectedAssessmentId ? getAssessment(selectedAssessmentId) : null;
      if(assess){
        ensureResponseMap(assess);
        setBaselineFor(assess.id, areaKey, assess.responses[areaKey]);
      }
    }catch(e){}
    if(typeof oldOpen === "function") oldOpen(areaKey);
  };

  // Expose recorder for save handler
  window.__recordHistoryForSave = function(assess, areaKey){
    try{
      if(!assess) return;
      ensureResponseMap(assess);
      if(!assess.history) assess.history = [];
      const s = sess();
      const user = s.username || window.__EDUFAD_USER__ || "‚Äî";
      const role = s.role || window.__EDUFAD_ROLE__ || "‚Äî";

      const before = getBaselineFor(assess.id, areaKey) || {};
      const after = jclone(assess.responses[areaKey] || {});
      const changes = diffAreaObj(areaKey, before, after);

      assess.history.push({ ts: Date.now(), user, role, areaKey, changes });

      // update baseline
      setBaselineFor(assess.id, areaKey, assess.responses[areaKey]);
    }catch(e){}
  };
})();
</script>


<script>
(function(){
  function forceDisclaimerPrivacy(){
    const o = document.getElementById("disclaimerOverlay");
    if(!o) return;
    // Se √® visibile, forziamo lo sfondo pieno
    const disp = getComputedStyle(o).display;
    if(disp !== "none"){
      o.style.background = "#0f172a";
      o.style.backdropFilter = "none";
      o.style.webkitBackdropFilter = "none";
    }
  }
  window.addEventListener("load", ()=>{
    setInterval(forceDisclaimerPrivacy, 300);
  });
})();
</script>


<script>
(function(){
  function ensureLegendButton(){
    if(document.getElementById("btnLegend")) return;
    const top = document.querySelector(".topbar") || document.querySelector("header");
    if(!top) return;

    const btn = document.createElement("button");
    btn.id = "btnLegend";
    btn.className = "btn ghost";
    btn.type = "button";
    btn.textContent = "Legenda";

    // place near logout if present
    const logout = document.getElementById("btnLogout");
    if(logout && logout.parentElement){
      logout.parentElement.insertBefore(btn, logout);
    }else{
      top.appendChild(btn);
    }

    btn.addEventListener("click", ()=>{
      const m = document.getElementById("legendModal");
      if(m) m.style.display = "flex";
    });
  }

  function bindLegendClose(){
    const close = document.getElementById("btnCloseLegend");
    if(close && !close.dataset.bound){
      close.dataset.bound = "1";
      close.addEventListener("click", ()=>{
        const m = document.getElementById("legendModal");
        if(m) m.style.display = "none";
      });
    }
    const modal = document.getElementById("legendModal");
    if(modal && !modal.dataset.bound){
      modal.dataset.bound = "1";
      modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.style.display="none"; });
      document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") modal.style.display="none"; });
    }
  }

  window.addEventListener("load", ()=>{
    ensureLegendButton();
    bindLegendClose();
    setInterval(()=>{ ensureLegendButton(); bindLegendClose(); }, 400);
  });
})();
</script>


</body>
</html>
